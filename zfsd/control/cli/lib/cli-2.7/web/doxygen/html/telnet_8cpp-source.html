<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CLI: telnet.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-20981143-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
</head><body>
<!-- Generated by Doxygen 1.5.1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_7ca5e860cc97c111944d6d090aaeaed5.html">cpp</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_909ff1c5a0fe7ebd415c9e08d3a715b8.html">src</a></div>
<h1>telnet.cpp</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">    Copyright (c) 2006-2011, Alexis Royer, http://alexis.royer.free.fr/CLI</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">    All rights reserved.</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">    Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">        * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
<a name="l00009"></a>00009 <span class="comment">        * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
<a name="l00010"></a>00010 <span class="comment">        * Neither the name of the CLI library project nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment">    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00013"></a>00013 <span class="comment">    "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00014"></a>00014 <span class="comment">    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="l00015"></a>00015 <span class="comment">    A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR</span>
<a name="l00016"></a>00016 <span class="comment">    CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
<a name="l00017"></a>00017 <span class="comment">    EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,</span>
<a name="l00018"></a>00018 <span class="comment">    PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR</span>
<a name="l00019"></a>00019 <span class="comment">    PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<a name="l00020"></a>00020 <span class="comment">    LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<a name="l00021"></a>00021 <span class="comment">    NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<a name="l00022"></a>00022 <span class="comment">    SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00023"></a>00023 <span class="comment">*/</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="pch_8h.html">cli/pch.h</a>"</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#ifndef CLI_WIN_NETWORK</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span><span class="preprocessor">    #include &lt;errno.h&gt;</span> <span class="comment">// errno</span>
<a name="l00030"></a>00030 <span class="preprocessor">    #define socket_errno errno</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="preprocessor">    #include &lt;sys/types.h&gt;</span> <span class="comment">// socket, bind, listen</span>
<a name="l00032"></a>00032 <span class="preprocessor">    #include &lt;sys/socket.h&gt;</span> <span class="comment">// socket, bind, listen</span>
<a name="l00033"></a>00033 <span class="preprocessor">    #include &lt;netinet/in.h&gt;</span> <span class="comment">// sockaddr_in</span>
<a name="l00034"></a>00034 <span class="preprocessor">    #include &lt;unistd.h&gt;</span> <span class="comment">// getpid</span>
<a name="l00035"></a>00035 <span class="preprocessor">#else</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">    #include &lt;winsock2.h&gt;</span> <span class="comment">// Windows sockets</span>
<a name="l00037"></a>00037 <span class="preprocessor">    #define socket_errno WSAGetLastError()</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">    #define socklen_t int</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">    #define EADDRINUSE WSAEADDRINUSE</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">    #define SHUT_RD SD_RECEIVE</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">    #define SHUT_WR SD_SEND</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span><span class="preprocessor">    #define SHUT_RDWR SD_BOTH</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">    #define close closesocket</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">    #define sleep(seconds) Sleep((seconds)*1000)</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>    <span class="comment">// Disable disturbing macros.</span>
<a name="l00046"></a>00046 <span class="preprocessor">    #undef DELETE</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdio.h&gt;</span> <span class="comment">// close</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;time.h&gt;</span> <span class="comment">// time</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#include "<a class="code" href="telnet_8h.html">cli/telnet.h</a>"</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include "<a class="code" href="shell_8h.html">cli/shell.h</a>"</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include "<a class="code" href="traces_8h.html">cli/traces.h</a>"</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <a class="code" href="namespace_8h.html#965caf70ca576c007bee150001248651">CLI_NS_USE</a>(cli)
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#ifndef CLI_TELNET_INPUT_BUFFER_SIZE</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">    #define CLI_TELNET_INPUT_BUFFER_SIZE 1024</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00065"></a>00065 <span class="preprocessor">#define CLI_TELNET_SERVER GetTelnetServerTraceClass()</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classTraceClass.html">TraceClass</a>&amp; GetTelnetServerTraceClass(<span class="keywordtype">void</span>)
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068     <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classTraceClass.html">TraceClass</a> cli_TelnetServerTraceClass(<span class="stringliteral">"CLI_TELNET_SERVER"</span>, <a class="code" href="classHelp.html">Help</a>()
<a name="l00069"></a>00069         .AddHelp(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">Help::LANG_EN</a>, <span class="stringliteral">"CLI telnet server traces"</span>)
<a name="l00070"></a>00070         .AddHelp(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">Help::LANG_FR</a>, <span class="stringliteral">"Traces de serveur telnet CLI"</span>));
<a name="l00071"></a>00071     <span class="keywordflow">return</span> cli_TelnetServerTraceClass;
<a name="l00072"></a>00072 }
<a name="l00074"></a>00074 <span class="preprocessor">#define CLI_TELNET_IN GetTelnetInTraceClass()</span>
<a name="l00076"></a>00076 <span class="preprocessor">static const TraceClass&amp; GetTelnetInTraceClass(void)</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>{
<a name="l00078"></a>00078     <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classTraceClass.html">TraceClass</a> cli_TelnetInTraceClass(<span class="stringliteral">"CLI_TELNET_IN"</span>, <a class="code" href="classHelp.html">Help</a>()
<a name="l00079"></a>00079         .AddHelp(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">Help::LANG_EN</a>, <span class="stringliteral">"CLI telnet connection input traces"</span>)
<a name="l00080"></a>00080         .AddHelp(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">Help::LANG_FR</a>, <span class="stringliteral">"Traces d'entrées d'une connexion telnet CLI"</span>));
<a name="l00081"></a>00081     <span class="keywordflow">return</span> cli_TelnetInTraceClass;
<a name="l00082"></a>00082 }
<a name="l00084"></a>00084 <span class="preprocessor">#define CLI_TELNET_OUT GetTelnetOutTraceClass()</span>
<a name="l00086"></a>00086 <span class="preprocessor">static const TraceClass&amp; GetTelnetOutTraceClass(void)</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>{
<a name="l00088"></a>00088     <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classTraceClass.html">TraceClass</a> cli_TelnetOutTraceClass(<span class="stringliteral">"CLI_TELNET_OUT"</span>, <a class="code" href="classHelp.html">Help</a>()
<a name="l00089"></a>00089         .AddHelp(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">Help::LANG_EN</a>, <span class="stringliteral">"CLI telnet connection output traces"</span>)
<a name="l00090"></a>00090         .AddHelp(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">Help::LANG_FR</a>, <span class="stringliteral">"Traces de sorties d'une connexion telnet CLI"</span>));
<a name="l00091"></a>00091     <span class="keywordflow">return</span> cli_TelnetOutTraceClass;
<a name="l00092"></a>00092 }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 TelnetServer::TelnetServer(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> UI_MaxConnections, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> UL_TcpPort, <span class="keyword">const</span> <a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3">ResourceString::LANG</a> E_Lang)
<a name="l00096"></a>00096   : m_iServerSocket(-1), m_ulTcpPort(UL_TcpPort), m_eLang(E_Lang),
<a name="l00097"></a>00097     m_tkConnections(UI_MaxConnections), m_uiMaxConnections(UI_MaxConnections)
<a name="l00098"></a>00098 {
<a name="l00099"></a>00099     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#6e460792b0696ff90a7d35f77a941c6d">Declare</a>(CLI_TELNET_SERVER);
<a name="l00100"></a>00100     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#6e460792b0696ff90a7d35f77a941c6d">Declare</a>(CLI_TELNET_IN);
<a name="l00101"></a>00101     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#6e460792b0696ff90a7d35f77a941c6d">Declare</a>(CLI_TELNET_OUT);
<a name="l00102"></a>00102 }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 <a class="code" href="classTelnetServer.html#ce9f6cf047ae8a1e427ca7ca5dcbce12">TelnetServer::~TelnetServer</a>(<span class="keywordtype">void</span>)
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="keywordtype">void</span> <a class="code" href="classTelnetServer.html#97520ee0f8761c9827cb13addc8ffd68">TelnetServer::StartServer</a>(<span class="keywordtype">void</span>)
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"Starting server on port "</span> &lt;&lt; m_ulTcpPort &lt;&lt; <a class="code" href="io__device_8h.html#d6d7d55b8cc249130097ce4007a1162a">endl</a>;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     m_iServerSocket = socket(AF_INET, SOCK_STREAM, 0);
<a name="l00113"></a>00113 <span class="preprocessor">#ifdef CLI_WIN_NETWORK</span>
<a name="l00114"></a>00114 <span class="preprocessor"></span>    <span class="comment">// Winsock needs to be initialized.</span>
<a name="l00115"></a>00115     <span class="keywordflow">if</span> (m_iServerSocket &lt; 0)
<a name="l00116"></a>00116     {
<a name="l00117"></a>00117         WORD wVersionRequested = MAKEWORD(2, 2);
<a name="l00118"></a>00118         WSADATA wsaData;
<a name="l00119"></a>00119         <span class="keywordtype">int</span> err = WSAStartup(wVersionRequested, &amp; wsaData);
<a name="l00120"></a>00120         <span class="keywordflow">if</span> (err == 0)
<a name="l00121"></a>00121         {
<a name="l00122"></a>00122             ((<span class="keywordtype">int</span>&amp;) m_iServerSocket) = socket(AF_INET, SOCK_STREAM, 0);
<a name="l00123"></a>00123         }
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125 <span class="preprocessor">#endif</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (m_iServerSocket &lt; 0)
<a name="l00127"></a>00127     {
<a name="l00128"></a>00128         <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_Error = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00129"></a>00129             .SetString(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"socket() failed"</span>)
<a name="l00130"></a>00130             .SetString(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec de la fonction socket()"</span>);
<a name="l00131"></a>00131         <a class="code" href="classOutputDevice.html#3f1e2af2786d5f17e295ce0718d901cf">OutputDevice::GetStdErr</a>() &lt;&lt; cli_Error.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00132"></a>00132         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00133"></a>00133         <span class="keywordflow">return</span>;
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"socket() successful (m_iServerSocket = "</span> &lt;&lt; m_iServerSocket &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     <span class="comment">// So that we can re-bind to it without TIME_WAIT problems</span>
<a name="l00138"></a>00138     <span class="keywordtype">int</span> i_ReuseAddr = 1;
<a name="l00139"></a>00139     <span class="keywordflow">if</span> (setsockopt(m_iServerSocket, SOL_SOCKET, SO_REUSEADDR, (<span class="keyword">const</span> <span class="keywordtype">char</span>*) &amp; i_ReuseAddr, <span class="keyword">sizeof</span>(i_ReuseAddr)) != 0)
<a name="l00140"></a>00140     {
<a name="l00141"></a>00141         close(m_iServerSocket);
<a name="l00142"></a>00142         <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_Error = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00143"></a>00143             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"setsockopt() failed"</span>)
<a name="l00144"></a>00144             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec de la fonction setsockopt()"</span>);
<a name="l00145"></a>00145         <a class="code" href="classOutputDevice.html#3f1e2af2786d5f17e295ce0718d901cf">OutputDevice::GetStdErr</a>() &lt;&lt; cli_Error.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00146"></a>00146         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00147"></a>00147         <span class="keywordflow">return</span>;
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="comment">// Bind the socket</span>
<a name="l00151"></a>00151     <span class="keyword">struct </span>sockaddr_in s_SockAddr;
<a name="l00152"></a>00152     s_SockAddr.sin_family = AF_INET;
<a name="l00153"></a>00153     s_SockAddr.sin_port = htons((<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>) m_ulTcpPort);
<a name="l00154"></a>00154     s_SockAddr.sin_addr.s_addr = INADDR_ANY;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156     <span class="keywordtype">int</span> i_BindTries = 0;
<a name="l00157"></a>00157     <span class="keywordflow">while</span> (bind(m_iServerSocket, (<span class="keyword">struct</span> sockaddr*) &amp; s_SockAddr, <span class="keyword">sizeof</span>(s_SockAddr)) &lt; 0)
<a name="l00158"></a>00158     {
<a name="l00159"></a>00159         i_BindTries ++;
<a name="l00160"></a>00160         <span class="keywordflow">if</span> ((socket_errno == EADDRINUSE) &amp;&amp; (i_BindTries &lt; 2))
<a name="l00161"></a>00161         {
<a name="l00162"></a>00162             sleep(500);
<a name="l00163"></a>00163         }
<a name="l00164"></a>00164         <span class="keywordflow">else</span>
<a name="l00165"></a>00165         {
<a name="l00166"></a>00166             close(m_iServerSocket);
<a name="l00167"></a>00167             <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_Error = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00168"></a>00168                 .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"bind() failed"</span>)
<a name="l00169"></a>00169                 .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec de la fonction bind()"</span>);
<a name="l00170"></a>00170             <a class="code" href="classOutputDevice.html#3f1e2af2786d5f17e295ce0718d901cf">OutputDevice::GetStdErr</a>() &lt;&lt; cli_Error.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00171"></a>00171             <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00172"></a>00172             <span class="keywordflow">return</span>;
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174     }
<a name="l00175"></a>00175     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"bind(m_iServerSocket) successful"</span> &lt;&lt; endl;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="comment">// Make the server listen up to m_uiMaxConnections clients.</span>
<a name="l00178"></a>00178     <span class="keywordflow">if</span> (listen(m_iServerSocket, m_uiMaxConnections) &lt; 0)
<a name="l00179"></a>00179     {
<a name="l00180"></a>00180         close(m_iServerSocket);
<a name="l00181"></a>00181         <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_Error = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00182"></a>00182             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"listen() failed"</span>)
<a name="l00183"></a>00183             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec de la fonction listen()"</span>);
<a name="l00184"></a>00184         <a class="code" href="classOutputDevice.html#3f1e2af2786d5f17e295ce0718d901cf">OutputDevice::GetStdErr</a>() &lt;&lt; cli_Error.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00185"></a>00185         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00186"></a>00186         <span class="keywordflow">return</span>;
<a name="l00187"></a>00187     }
<a name="l00188"></a>00188     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"listen(m_iServerSocket) successful"</span> &lt;&lt; endl;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"Waiting for clients..."</span> &lt;&lt; endl;
<a name="l00191"></a>00191     <span class="keywordflow">while</span> (m_iServerSocket &gt;= 0)
<a name="l00192"></a>00192     {
<a name="l00193"></a>00193         <span class="keywordflow">if</span> (! RunLoop(-1))
<a name="l00194"></a>00194         {
<a name="l00195"></a>00195             <span class="keywordflow">break</span>;
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197     }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"Server is turning off..."</span> &lt;&lt; endl;
<a name="l00200"></a>00200     TerminateServer();
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"Server is done."</span> &lt;&lt; endl;
<a name="l00203"></a>00203 }
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="keywordtype">void</span> <a class="code" href="classTelnetServer.html#acfa006d3f26b67ce5fbc36041ca6e8f">TelnetServer::StopServer</a>(<span class="keywordtype">void</span>)
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207     <span class="comment">// First of all, unset the main socket reference to let the server loop know about the stop server procedure.</span>
<a name="l00208"></a>00208     <span class="keyword">const</span> <span class="keywordtype">int</span> i_ServerSocket = m_iServerSocket;
<a name="l00209"></a>00209     m_iServerSocket = -1;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="comment">// Release server resources</span>
<a name="l00212"></a>00212     <span class="keywordflow">if</span> (i_ServerSocket &gt;= 0)
<a name="l00213"></a>00213     {
<a name="l00214"></a>00214         <span class="keywordflow">if</span> (close(i_ServerSocket) != 0)
<a name="l00215"></a>00215         {
<a name="l00216"></a>00216             <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_Error = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00217"></a>00217                 .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"close(m_iServerSocket) failed"</span>)
<a name="l00218"></a>00218                 .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec de la fonction close()"</span>);
<a name="l00219"></a>00219             <a class="code" href="classOutputDevice.html#3f1e2af2786d5f17e295ce0718d901cf">OutputDevice::GetStdErr</a>() &lt;&lt; cli_Error.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00220"></a>00220             <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00221"></a>00221             <span class="keywordflow">return</span>;
<a name="l00222"></a>00222         }
<a name="l00223"></a>00223         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"close(m_iServerSocket) successful"</span> &lt;&lt; endl;
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225 }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227 <span class="keyword">const</span> <span class="keywordtype">bool</span> TelnetServer::RunLoop(<span class="keyword">const</span> <span class="keywordtype">int</span> I_Milli)
<a name="l00228"></a>00228 {
<a name="l00229"></a>00229     <span class="comment">// Prepare a fd_set structure to call select().</span>
<a name="l00230"></a>00230     fd_set fd_Sockets; FD_ZERO(&amp; fd_Sockets);
<a name="l00231"></a>00231     <span class="comment">// Peek the server socket to detect new connections.</span>
<a name="l00232"></a>00232     FD_SET(m_iServerSocket, &amp; fd_Sockets);
<a name="l00233"></a>00233     <span class="comment">// Peek known connections for input data and remember each known socket (for consistency).</span>
<a name="l00234"></a>00234     tk::Queue&lt;int&gt; tk_Sockets(m_uiMaxConnections);
<a name="l00235"></a>00235     <span class="keywordflow">for</span> (   tk::Map&lt;int, ConnectionInfo&gt;::Iterator it = m_tkConnections.GetIterator();
<a name="l00236"></a>00236             m_tkConnections.IsValid(it);
<a name="l00237"></a>00237             m_tkConnections.MoveNext(it))
<a name="l00238"></a>00238     {
<a name="l00239"></a>00239         <span class="keyword">const</span> ConnectionInfo cli_Info = m_tkConnections.GetAt(it);
<a name="l00240"></a>00240         FD_SET(cli_Info.i_Socket, &amp; fd_Sockets);
<a name="l00241"></a>00241         tk_Sockets.AddTail(cli_Info.i_Socket);
<a name="l00242"></a>00242     }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <span class="comment">// Set timeout as required.</span>
<a name="l00245"></a>00245     timeval t_Timeout, *pt_Timeout = NULL;
<a name="l00246"></a>00246     <span class="keywordflow">if</span> (I_Milli &gt;= 0)
<a name="l00247"></a>00247     {
<a name="l00248"></a>00248         t_Timeout.tv_sec = I_Milli / 1000;
<a name="l00249"></a>00249         t_Timeout.tv_usec = (I_Milli * 1000) % 1000000;
<a name="l00250"></a>00250         pt_Timeout = &amp; t_Timeout;
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="comment">// Check the server is still running.</span>
<a name="l00254"></a>00254     <span class="keywordflow">if</span> (m_iServerSocket &lt; 0)
<a name="l00255"></a>00255     {
<a name="l00256"></a>00256         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00257"></a>00257     }
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="comment">// Use select.</span>
<a name="l00260"></a>00260     <span class="keyword">const</span> <span class="keywordtype">int</span> i_Select = select(FD_SETSIZE, &amp; fd_Sockets, NULL, NULL, pt_Timeout);
<a name="l00261"></a>00261     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"select() returned "</span> &lt;&lt; i_Select &lt;&lt; endl;
<a name="l00262"></a>00262     <span class="keywordflow">if</span> (i_Select &lt; 0)
<a name="l00263"></a>00263     {
<a name="l00264"></a>00264         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"select() failed, errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00265"></a>00265         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <span class="comment">// Check the server is still running.</span>
<a name="l00269"></a>00269     <span class="keywordflow">if</span> (m_iServerSocket &lt; 0)
<a name="l00270"></a>00270     {
<a name="l00271"></a>00271         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="comment">// Are there new connections?</span>
<a name="l00275"></a>00275     <span class="keywordflow">if</span> (FD_ISSET(m_iServerSocket, &amp; fd_Sockets))
<a name="l00276"></a>00276     {
<a name="l00277"></a>00277         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"FD_ISSET(m_iServerSocket, &amp; fd_Sockets) = "</span> &lt;&lt; FD_ISSET(m_iServerSocket, &amp; fd_Sockets) &lt;&lt; endl;
<a name="l00278"></a>00278         <span class="comment">// New client.</span>
<a name="l00279"></a>00279         <span class="keywordflow">if</span> (! AcceptConnection())
<a name="l00280"></a>00280         {
<a name="l00281"></a>00281             <span class="comment">// If the client cannot be accepted, let's continue whatever.</span>
<a name="l00282"></a>00282             <span class="comment">//return false;</span>
<a name="l00283"></a>00283         }
<a name="l00284"></a>00284     }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <span class="comment">// Is there data for known connections?</span>
<a name="l00287"></a>00287     <span class="keywordflow">while</span> (! tk_Sockets.IsEmpty())
<a name="l00288"></a>00288     {
<a name="l00289"></a>00289         <span class="keyword">const</span> <span class="keywordtype">int</span> i_ConnectionSocket = tk_Sockets.RemoveHead();
<a name="l00290"></a>00290         <span class="keywordflow">if</span> (<span class="keyword">const</span> ConnectionInfo* <span class="keyword">const</span> pcli_Info = m_tkConnections.GetAt(i_ConnectionSocket))
<a name="l00291"></a>00291         {
<a name="l00292"></a>00292             <span class="keywordflow">if</span> (FD_ISSET(pcli_Info-&gt;i_Socket, &amp; fd_Sockets))
<a name="l00293"></a>00293             {
<a name="l00294"></a>00294                 <span class="keywordflow">if</span> (<span class="keyword">const</span> <a class="code" href="classTelnetConnection.html">TelnetConnection</a>* <span class="keyword">const</span> pcli_Connection = pcli_Info-&gt;pcli_Connection)
<a name="l00295"></a>00295                 {
<a name="l00296"></a>00296                     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER)
<a name="l00297"></a>00297                         &lt;&lt; <span class="stringliteral">"FD_ISSET("</span> &lt;&lt; pcli_Info-&gt;i_Socket &lt;&lt; <span class="stringliteral">" , &amp; fd_Sockets) "</span>
<a name="l00298"></a>00298                         &lt;&lt; <span class="stringliteral">"= "</span> &lt;&lt; FD_ISSET(pcli_Info-&gt;i_Socket, &amp; fd_Sockets) &lt;&lt; endl;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300                     <span class="comment">// If ReceiveChars() or ProcessKeys() fail, this is just a client error =&gt; do not consider a server error.</span>
<a name="l00301"></a>00301                     <span class="comment">// Do not avoid neither ProcessKeys() depending on the return of ReceiveChars() (stack could just be full).</span>
<a name="l00302"></a>00302                     pcli_Connection-&gt;ReceiveChars();
<a name="l00303"></a>00303                     pcli_Connection-&gt;ProcessKeys();
<a name="l00304"></a>00304                 }
<a name="l00305"></a>00305             }
<a name="l00306"></a>00306         }
<a name="l00307"></a>00307     }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00310"></a>00310 }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312 <span class="keyword">const</span> <span class="keywordtype">bool</span> TelnetServer::AcceptConnection(<span class="keywordtype">void</span>)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314     <span class="comment">// Accept the client</span>
<a name="l00315"></a>00315     <span class="keyword">const</span> <span class="keywordtype">int</span> i_ConnectionSocket = accept(m_iServerSocket, NULL, NULL);
<a name="l00316"></a>00316     <span class="keywordflow">if</span> (i_ConnectionSocket &lt; 0)
<a name="l00317"></a>00317     {
<a name="l00318"></a>00318         <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_Error = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00319"></a>00319             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"accept() failed"</span>)
<a name="l00320"></a>00320             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec de la fonction accept()"</span>);
<a name="l00321"></a>00321         <a class="code" href="classOutputDevice.html#3f1e2af2786d5f17e295ce0718d901cf">OutputDevice::GetStdErr</a>() &lt;&lt; cli_Error.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00322"></a>00322         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00323"></a>00323         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00324"></a>00324     }
<a name="l00325"></a>00325     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"accept() successful (i_ConnectionSocket = "</span> &lt;&lt; i_ConnectionSocket &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
<a name="l00326"></a>00326     <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_InfoClient = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00327"></a>00327         .SetString(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"Accepting telnet connection"</span>)
<a name="l00328"></a>00328         .SetString(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Connexion telnet acceptée"</span>);
<a name="l00329"></a>00329     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; cli_InfoClient.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="comment">// Once every socket configuration is done, make object configuration.</span>
<a name="l00332"></a>00332     <span class="keywordflow">if</span> (<a class="code" href="classTelnetConnection.html">TelnetConnection</a>* <span class="keyword">const</span> pcli_Connection = <span class="keyword">new</span> <a class="code" href="classTelnetServer.html#55b375b891e17a0493689bf56604b912">TelnetConnection</a>(<span class="keyword">this</span>, i_ConnectionSocket, m_eLang, <span class="keyword">true</span>))
<a name="l00333"></a>00333     {
<a name="l00334"></a>00334         <span class="comment">// First check we do not have too many connections.</span>
<a name="l00335"></a>00335         <span class="keywordflow">if</span> (m_tkConnections.GetCount() &gt;= m_uiMaxConnections)
<a name="l00336"></a>00336         {
<a name="l00337"></a>00337             <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_Error = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00338"></a>00338                 .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"Too many connections!"</span>)
<a name="l00339"></a>00339                 .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Nombre de connexions dépassé."</span>);
<a name="l00340"></a>00340             <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; cli_Error.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00341"></a>00341             <span class="keywordflow">if</span> (pcli_Connection-&gt;OpenUp(<a class="code" href="debug_8h.html#12506d620d4ecd0161866c9b19d761ed">__CALL_INFO__</a>))
<a name="l00342"></a>00342             {
<a name="l00343"></a>00343                 *pcli_Connection &lt;&lt; cli_Error.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00344"></a>00344                 <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_Sorry = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00345"></a>00345                     .SetString(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"Sorry."</span>)
<a name="l00346"></a>00346                     .SetString(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Désolé."</span>);
<a name="l00347"></a>00347                 *pcli_Connection &lt;&lt; cli_Sorry.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00348"></a>00348                 pcli_Connection-&gt;CloseDown(<a class="code" href="debug_8h.html#12506d620d4ecd0161866c9b19d761ed">__CALL_INFO__</a>);
<a name="l00349"></a>00349             }
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351         <span class="keywordflow">else</span>
<a name="l00352"></a>00352         {
<a name="l00353"></a>00353             <span class="comment">// Create the appropriate shell.</span>
<a name="l00354"></a>00354             <span class="keywordflow">if</span> (<a class="code" href="classShell.html">Shell</a>* <span class="keyword">const</span> pcli_Shell = <a class="code" href="classTelnetServer.html#6a062157e3656af728594db05d2748ba">OnNewConnection</a>(*pcli_Connection))
<a name="l00355"></a>00355             {
<a name="l00356"></a>00356                 <span class="comment">// Store in the connection registry.</span>
<a name="l00357"></a>00357                 <span class="keyword">const</span> ConnectionInfo s_ConnectionInfo = { i_ConnectionSocket, pcli_Connection, pcli_Shell };
<a name="l00358"></a>00358                 <span class="keywordflow">if</span> ((! m_tkConnections.IsSet(i_ConnectionSocket))
<a name="l00359"></a>00359                     &amp;&amp; m_tkConnections.SetAt(i_ConnectionSocket, s_ConnectionInfo))
<a name="l00360"></a>00360                 {
<a name="l00361"></a>00361                     <span class="comment">// Run the shell on that telnet connection.</span>
<a name="l00362"></a>00362                     pcli_Connection-&gt;UseInstance(<a class="code" href="debug_8h.html#12506d620d4ecd0161866c9b19d761ed">__CALL_INFO__</a>);
<a name="l00363"></a>00363                     pcli_Shell-&gt;Run(*pcli_Connection);
<a name="l00364"></a>00364 
<a name="l00365"></a>00365                     <span class="comment">// Since telnet connections are non-blocking devices, let's return successfully right now.</span>
<a name="l00366"></a>00366                     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00367"></a>00367                 }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369     <span class="comment">// Fallback releases.</span>
<a name="l00370"></a>00370                 <a class="code" href="classTelnetServer.html#b46ec06c9f295d30833916c08e6dcd68">OnCloseConnection</a>(pcli_Shell, *pcli_Connection); <span class="comment">// Shell.</span>
<a name="l00371"></a>00371             }
<a name="l00372"></a>00372         }
<a name="l00373"></a>00373         <span class="keyword">delete</span> pcli_Connection; <span class="comment">// Telnet connection instance.</span>
<a name="l00374"></a>00374     }
<a name="l00375"></a>00375     close(i_ConnectionSocket); <span class="comment">// Socket.</span>
<a name="l00376"></a>00376     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00377"></a>00377 }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 <span class="keyword">const</span> <span class="keywordtype">bool</span> TelnetServer::CloseConnection(<span class="keyword">const</span> <span class="keywordtype">int</span> I_ConnectionSocket)
<a name="l00380"></a>00380 {
<a name="l00381"></a>00381     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"Ending connection "</span> &lt;&lt; I_ConnectionSocket &lt;&lt; <span class="stringliteral">"..."</span> &lt;&lt; endl;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="comment">// Release objects.</span>
<a name="l00384"></a>00384     <span class="keywordflow">if</span> (<span class="keyword">const</span> ConnectionInfo* <span class="keyword">const</span> pcli_Info = m_tkConnections.GetAt(I_ConnectionSocket))
<a name="l00385"></a>00385     {
<a name="l00386"></a>00386         <span class="keywordflow">if</span> (<a class="code" href="classTelnetConnection.html">TelnetConnection</a>* <span class="keyword">const</span> pcli_Connection = pcli_Info-&gt;pcli_Connection)
<a name="l00387"></a>00387         {
<a name="l00388"></a>00388             <span class="keywordflow">if</span> (<a class="code" href="classShell.html">Shell</a>* <span class="keyword">const</span> pcli_Shell = pcli_Info-&gt;pcli_Shell)
<a name="l00389"></a>00389             {
<a name="l00390"></a>00390                 <a class="code" href="classTelnetServer.html#b46ec06c9f295d30833916c08e6dcd68">OnCloseConnection</a>(pcli_Shell, *pcli_Connection);
<a name="l00391"></a>00391             }
<a name="l00392"></a>00392             pcli_Connection-&gt;FreeInstance(<a class="code" href="debug_8h.html#12506d620d4ecd0161866c9b19d761ed">__CALL_INFO__</a>);
<a name="l00393"></a>00393         }
<a name="l00394"></a>00394         m_tkConnections.Unset(I_ConnectionSocket);
<a name="l00395"></a>00395     }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00398"></a>00398 }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400 <span class="keyword">const</span> <span class="keywordtype">bool</span> TelnetServer::TerminateServer(<span class="keywordtype">void</span>)
<a name="l00401"></a>00401 {
<a name="l00402"></a>00402     <span class="keywordtype">bool</span> b_Res = <span class="keyword">true</span>;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="comment">// Close all client connections.</span>
<a name="l00405"></a>00405     <span class="keywordflow">while</span> (! m_tkConnections.IsEmpty())
<a name="l00406"></a>00406     {
<a name="l00407"></a>00407         tk::Map&lt;int, ConnectionInfo&gt;::Iterator it = m_tkConnections.GetIterator();
<a name="l00408"></a>00408         <span class="keywordflow">if</span> (m_tkConnections.IsValid(it))
<a name="l00409"></a>00409         {
<a name="l00410"></a>00410             <span class="keyword">const</span> ConnectionInfo cli_Info = m_tkConnections.Remove(it);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412             <span class="comment">// Let the shell terminate.</span>
<a name="l00413"></a>00413             <span class="keywordflow">if</span> (cli_Info.pcli_Shell != NULL)
<a name="l00414"></a>00414             {
<a name="l00415"></a>00415                 <span class="keywordflow">if</span> (cli_Info.pcli_Shell-&gt;IsRunning())
<a name="l00416"></a>00416                 {
<a name="l00417"></a>00417                     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#69bc0bc6fcd2a39cb61304e6b92506c2">Trace</a>(CLI_TELNET_SERVER) &lt;&lt; <span class="stringliteral">"Terminating shell of connection "</span> &lt;&lt; cli_Info.i_Socket &lt;&lt; <span class="stringliteral">"..."</span> &lt;&lt; cli::endl;
<a name="l00418"></a>00418                     cli_Info.pcli_Shell-&gt;Quit();
<a name="l00419"></a>00419                 }
<a name="l00420"></a>00420             }
<a name="l00421"></a>00421         }
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     <span class="keywordflow">return</span> b_Res;
<a name="l00425"></a>00425 }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 TelnetConnection::TelnetConnection(
<a name="l00429"></a>00429         <a class="code" href="classTelnetServer.html">TelnetServer</a>* <span class="keyword">const</span> PCLI_Server,
<a name="l00430"></a>00430         <span class="keyword">const</span> <span class="keywordtype">int</span> I_ConnectionSocket, <span class="keyword">const</span> <a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3">ResourceString::LANG</a> E_Lang,
<a name="l00431"></a>00431         <span class="keyword">const</span> <span class="keywordtype">bool</span> B_AutoDelete)
<a name="l00432"></a>00432   : <a class="code" href="classNonBlockingIODevice.html">NonBlockingIODevice</a>(<span class="stringliteral">"telnet"</span>, B_AutoDelete),
<a name="l00433"></a>00433     m_pcliServer(PCLI_Server),
<a name="l00434"></a>00434     m_iSocket(I_ConnectionSocket), m_eLang(E_Lang),
<a name="l00435"></a>00435     m_qChars(<a class="code" href="preprocessing_8h.html#c9caea23061b23d302f307a82a8ae779">CLI_TELNET_INPUT_BUFFER_SIZE</a>), m_bWaitingForKeys(false)
<a name="l00436"></a>00436 {
<a name="l00437"></a>00437 }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439 <a class="code" href="classTelnetConnection.html#8689fb73dc61bbb43d8c72521d9a7d81">TelnetConnection::~TelnetConnection</a>(<span class="keywordtype">void</span>)
<a name="l00440"></a>00440 {
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 <span class="keyword">const</span> <span class="keywordtype">bool</span> <a class="code" href="classTelnetConnection.html#e87d5ea164dbdabb856c34db2b621a7c">TelnetConnection::OpenDevice</a>(<span class="keywordtype">void</span>)
<a name="l00444"></a>00444 {
<a name="l00445"></a>00445     <span class="comment">// Configure LINGER option</span>
<a name="l00446"></a>00446     linger t_Linger;
<a name="l00447"></a>00447     t_Linger.l_onoff = 1; <span class="comment">// enable LINGER</span>
<a name="l00448"></a>00448     t_Linger.l_linger = 1; <span class="comment">// seconds</span>
<a name="l00449"></a>00449     <span class="keywordflow">if</span> (setsockopt(m_iSocket, SOL_SOCKET, SO_LINGER, (<span class="keyword">const</span> <span class="keywordtype">char</span>*) &amp; t_Linger, <span class="keyword">sizeof</span>(t_Linger)) != 0)
<a name="l00450"></a>00450     {
<a name="l00451"></a>00451         <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_Error = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00452"></a>00452             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"setsockopt(SO_LINGER) failed"</span>)
<a name="l00453"></a>00453             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec de la fonction setsockopt(SO_LINGER)"</span>);
<a name="l00454"></a>00454         <a class="code" href="classOutputDevice.html#3f1e2af2786d5f17e295ce0718d901cf">OutputDevice::GetStdErr</a>() &lt;&lt; cli_Error.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00455"></a>00455         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_SERVER, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00456"></a>00456         <a class="code" href="classTelnetConnection.html#c7acd3e206a292f35f55c1b5d4597f7c">CloseDevice</a>();
<a name="l00457"></a>00457         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00458"></a>00458     }
<a name="l00459"></a>00459     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_SERVER, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"setsockopt("</span> &lt;&lt; m_iSocket &lt;&lt; <span class="stringliteral">", SO_LINGER) successful"</span> &lt;&lt; endl;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00462"></a>00462 }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464 <span class="keyword">const</span> <span class="keywordtype">bool</span> <a class="code" href="classTelnetConnection.html#c7acd3e206a292f35f55c1b5d4597f7c">TelnetConnection::CloseDevice</a>(<span class="keywordtype">void</span>)
<a name="l00465"></a>00465 {
<a name="l00466"></a>00466     <span class="comment">// Did not manage to correctly end up the connection on the server side,</span>
<a name="l00467"></a>00467     <span class="comment">// neither on Windows nor Linux systems.</span>
<a name="l00468"></a>00468     <span class="comment">// This a hack until I provide another implementation.</span>
<a name="l00469"></a>00469     {
<a name="l00470"></a>00470         linger t_Linger; socklen_t i_Len = <span class="keyword">sizeof</span>(t_Linger);
<a name="l00471"></a>00471         <span class="keywordflow">if</span> (getsockopt(m_iSocket, SOL_SOCKET, SO_LINGER, (<span class="keywordtype">char</span>*) &amp; t_Linger, &amp; i_Len) != 0)
<a name="l00472"></a>00472         {
<a name="l00473"></a>00473             close(m_iSocket);
<a name="l00474"></a>00474             <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_Error = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00475"></a>00475                 .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"getsockopt(SO_LINGER) failed"</span>)
<a name="l00476"></a>00476                 .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec de la fonction getsockopt(SO_LINGER)"</span>);
<a name="l00477"></a>00477             <a class="code" href="classOutputDevice.html#3f1e2af2786d5f17e295ce0718d901cf">OutputDevice::GetStdErr</a>() &lt;&lt; cli_Error.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00478"></a>00478             <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_SERVER, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00479"></a>00479             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00480"></a>00480         }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482         <span class="keywordflow">if</span> (t_Linger.l_onoff)
<a name="l00483"></a>00483         {
<a name="l00484"></a>00484             sleep(t_Linger.l_linger);
<a name="l00485"></a>00485         }
<a name="l00486"></a>00486     }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="comment">// Stop sending characters</span>
<a name="l00489"></a>00489     <span class="keywordflow">if</span> (shutdown(m_iSocket, SHUT_WR) != 0)
<a name="l00490"></a>00490     {
<a name="l00491"></a>00491         close(m_iSocket);
<a name="l00492"></a>00492         <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_Error = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00493"></a>00493             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"shutdown() failed"</span>)
<a name="l00494"></a>00494             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec de la fonction shutdown()"</span>);
<a name="l00495"></a>00495         <a class="code" href="classOutputDevice.html#3f1e2af2786d5f17e295ce0718d901cf">OutputDevice::GetStdErr</a>() &lt;&lt; cli_Error.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00496"></a>00496         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_SERVER, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00497"></a>00497         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_SERVER, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"shutdown("</span> &lt;&lt; m_iSocket &lt;&lt; <span class="stringliteral">") successful"</span> &lt;&lt; endl;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     <span class="comment">// Release resources</span>
<a name="l00502"></a>00502     <span class="keywordflow">if</span> (close(m_iSocket) != 0)
<a name="l00503"></a>00503     {
<a name="l00504"></a>00504         <span class="keyword">const</span> <a class="code" href="classResourceString.html">ResourceString</a> cli_Error = <a class="code" href="classResourceString.html">ResourceString</a>()
<a name="l00505"></a>00505             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"close() failed"</span>)
<a name="l00506"></a>00506             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec de la fonction close()"</span>);
<a name="l00507"></a>00507         <a class="code" href="classOutputDevice.html#3f1e2af2786d5f17e295ce0718d901cf">OutputDevice::GetStdErr</a>() &lt;&lt; cli_Error.<a class="code" href="classResourceString.html#9810e21c1e7ec3ab7f45c099f15fd7f7">GetString</a>(m_eLang) &lt;&lt; endl;
<a name="l00508"></a>00508         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_SERVER, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00509"></a>00509         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00510"></a>00510     }
<a name="l00511"></a>00511     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_SERVER, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"close("</span> &lt;&lt; m_iSocket &lt;&lt; <span class="stringliteral">") successful"</span> &lt;&lt; endl;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00514"></a>00514 }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 <span class="keyword">const</span> <span class="keywordtype">bool</span> <a class="code" href="classTelnetConnection.html#7f04cc2f8f6c861760807da8556ec008">TelnetConnection::ReceiveChars</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span>
<a name="l00517"></a>00517 <span class="keyword"></span>{
<a name="l00518"></a>00518     <span class="comment">// Dequeue characters from the socket</span>
<a name="l00519"></a>00519     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"m_iSocket = "</span> &lt;&lt; m_iSocket &lt;&lt; <span class="stringliteral">", calling recv()..."</span> &lt;&lt; endl;
<a name="l00520"></a>00520     <span class="keyword">const</span> <span class="keywordtype">int</span> i_LenMax = ((m_qChars.GetCount() + 256 &gt; <a class="code" href="preprocessing_8h.html#c9caea23061b23d302f307a82a8ae779">CLI_TELNET_INPUT_BUFFER_SIZE</a>) ? (<a class="code" href="preprocessing_8h.html#c9caea23061b23d302f307a82a8ae779">CLI_TELNET_INPUT_BUFFER_SIZE</a> - m_qChars.GetCount()) : 256);
<a name="l00521"></a>00521     <span class="keywordtype">char</span> arc_Buffer[256];
<a name="l00522"></a>00522     <span class="keyword">const</span> <span class="keywordtype">int</span> i_Len = recv(m_iSocket, arc_Buffer, i_LenMax, 0);
<a name="l00523"></a>00523     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"recv() returned "</span> &lt;&lt; i_Len &lt;&lt; endl;
<a name="l00524"></a>00524     <span class="keywordflow">if</span> (i_Len &lt;= 0)
<a name="l00525"></a>00525     {
<a name="l00526"></a>00526         <a class="code" href="classOutputDevice.html#c831dff60351f1a3dffd667e175e8f23">m_cliLastError</a>
<a name="l00527"></a>00527             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"Telnet reception error"</span>)
<a name="l00528"></a>00528             .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec de réception en telnet"</span>);
<a name="l00529"></a>00529         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"recv() failed, errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00530"></a>00530         <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471e42682039e1a584113718465a202d0c0">NULL_KEY</a>;
<a name="l00531"></a>00531     }
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     <span class="comment">// Queue them in the internal fifo</span>
<a name="l00534"></a>00534     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;i_Len; i++)
<a name="l00535"></a>00535     {
<a name="l00536"></a>00536         <span class="keywordflow">if</span> (arc_Buffer[i] != <span class="charliteral">'\0'</span>)
<a name="l00537"></a>00537         {
<a name="l00538"></a>00538             <span class="keywordflow">if</span> (! m_qChars.AddTail(arc_Buffer[i]))
<a name="l00539"></a>00539             {
<a name="l00540"></a>00540                 <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(<a class="code" href="traces_8h.html#243b1b1f8ca7e7e98ac73a2d115256f4">INTERNAL_ERROR</a>, *<span class="keyword">this</span>)
<a name="l00541"></a>00541                     &lt;&lt; <span class="stringliteral">"TelnetConnection::GetKey(): "</span>
<a name="l00542"></a>00542                     &lt;&lt; <span class="stringliteral">"Could not append character '"</span> &lt;&lt; arc_Buffer[i] &lt;&lt; <span class="stringliteral">"' "</span>
<a name="l00543"></a>00543                     &lt;&lt; <span class="stringliteral">"to m_qChars"</span> &lt;&lt; endl;
<a name="l00544"></a>00544                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00545"></a>00545             }
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548 
<a name="l00549"></a>00549     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="keyword">const</span> <span class="keywordtype">bool</span> <a class="code" href="classTelnetConnection.html#24edca24d831bfe1d5379fbdd2ec8db4">TelnetConnection::ProcessKeys</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span>
<a name="l00553"></a>00553 <span class="keyword"></span>{
<a name="l00554"></a>00554     <span class="keywordflow">while</span> (<a class="code" href="classTelnetConnection.html#9c2dfe32088fb860e2ab9d3a88c38d51">CheckUp</a>() &amp;&amp; (! m_qChars.IsEmpty()))
<a name="l00555"></a>00555     {
<a name="l00556"></a>00556         <span class="keyword">const</span> <a class="code" href="io__device_8h.html#90d295cf6b6bc9873c186cc8851147f8">KEY</a> e_Key = <a class="code" href="classTelnetConnection.html#e3858fcf54afc30be3a18370b0623eac">GetKey</a>();
<a name="l00557"></a>00557         <span class="keywordflow">if</span> (e_Key == <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471e42682039e1a584113718465a202d0c0">NULL_KEY</a>)
<a name="l00558"></a>00558         {
<a name="l00559"></a>00559             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00560"></a>00560         }
<a name="l00561"></a>00561         <span class="keywordflow">else</span>
<a name="l00562"></a>00562         {
<a name="l00563"></a>00563             <a class="code" href="classTelnetConnection.html#24ac224b53c4a456be846f847738b26e">OnKey</a>(e_Key);
<a name="l00564"></a>00564         }
<a name="l00565"></a>00565     }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00568"></a>00568 }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570 <span class="keyword">const</span> <span class="keywordtype">bool</span> <a class="code" href="classTelnetConnection.html#9c2dfe32088fb860e2ab9d3a88c38d51">TelnetConnection::CheckUp</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span>
<a name="l00571"></a>00571 <span class="keyword"></span>{
<a name="l00572"></a>00572     <span class="keyword">const</span> <a class="code" href="classShell.html">Shell</a>* <span class="keyword">const</span> pcli_Shell = <a class="code" href="classNonBlockingIODevice.html#3f8a39f646f769f8e206f7f32fe01ace">GetShell</a>();
<a name="l00573"></a>00573     <span class="keywordflow">if</span> ((pcli_Shell == NULL) || (! pcli_Shell-&gt;<a class="code" href="classShell.html#562d5552796bb86d3fcc5a3ce0680cf4">IsRunning</a>()))
<a name="l00574"></a>00574     {
<a name="l00575"></a>00575         <span class="comment">// The shell is done. Hold on!</span>
<a name="l00576"></a>00576         <span class="keywordflow">if</span> (m_pcliServer != NULL)
<a name="l00577"></a>00577         {
<a name="l00578"></a>00578             m_pcliServer-&gt;<a class="code" href="classTelnetServer.html#e52479a40837afb41362052e0305cc5c">CloseConnection</a>(m_iSocket);
<a name="l00579"></a>00579         }
<a name="l00580"></a>00580         <span class="keywordflow">else</span>
<a name="l00581"></a>00581         {
<a name="l00582"></a>00582             const_cast&lt;TelnetConnection*&gt;(<span class="keyword">this</span>)-&gt;<a class="code" href="classTelnetConnection.html#c7acd3e206a292f35f55c1b5d4597f7c">CloseDevice</a>();
<a name="l00583"></a>00583         }
<a name="l00584"></a>00584         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00588"></a>00588 }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 <span class="keyword">const</span> <a class="code" href="io__device_8h.html#90d295cf6b6bc9873c186cc8851147f8">KEY</a> <a class="code" href="classTelnetConnection.html#e3858fcf54afc30be3a18370b0623eac">TelnetConnection::GetKey</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span>
<a name="l00591"></a>00591 <span class="keyword"></span>{
<a name="l00592"></a>00592     <span class="comment">// Wait for characters if needed</span>
<a name="l00593"></a>00593     <span class="keywordtype">bool</span> b_ReceiveCharacters = <span class="keyword">false</span>;
<a name="l00594"></a>00594     <span class="keywordflow">if</span> (m_qChars.IsEmpty())
<a name="l00595"></a>00595     {
<a name="l00596"></a>00596         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"m_qChars.GetCount() = "</span> &lt;&lt; m_qChars.GetCount() &lt;&lt; endl;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         b_ReceiveCharacters = <span class="keyword">true</span>;
<a name="l00599"></a>00599     }
<a name="l00600"></a>00600     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_qChars.GetCount() &lt; 10)
<a name="l00601"></a>00601     {
<a name="l00602"></a>00602         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"m_qChars.GetCount() = "</span> &lt;&lt; m_qChars.GetCount() &lt;&lt; endl;
<a name="l00603"></a>00603 
<a name="l00604"></a>00604         <span class="comment">// Just peek the socket to read if there are characters remaining</span>
<a name="l00605"></a>00605         fd_set fd_Read; FD_ZERO(&amp; fd_Read); FD_SET(m_iSocket, &amp; fd_Read);
<a name="l00606"></a>00606         timeval t_Timeout; t_Timeout.tv_sec = 0; t_Timeout.tv_usec = 10000;
<a name="l00607"></a>00607         <span class="keyword">const</span> <span class="keywordtype">int</span> i_Select = select(FD_SETSIZE, &amp; fd_Read, NULL, NULL, &amp; t_Timeout);
<a name="l00608"></a>00608         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"select() returned "</span> &lt;&lt; i_Select &lt;&lt; endl;
<a name="l00609"></a>00609         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"FD_ISSET(m_iSocket, &amp; fd_Read) = "</span> &lt;&lt; FD_ISSET(m_iSocket, &amp; fd_Read) &lt;&lt; endl;
<a name="l00610"></a>00610         <span class="keywordflow">if</span> ((i_Select &gt; 0) &amp;&amp; FD_ISSET(m_iSocket, &amp; fd_Read))
<a name="l00611"></a>00611         {
<a name="l00612"></a>00612             b_ReceiveCharacters = <span class="keyword">true</span>;
<a name="l00613"></a>00613         }
<a name="l00614"></a>00614         <span class="keywordflow">if</span> (i_Select &lt; 0)
<a name="l00615"></a>00615         {
<a name="l00616"></a>00616             <a class="code" href="classOutputDevice.html#c831dff60351f1a3dffd667e175e8f23">m_cliLastError</a>
<a name="l00617"></a>00617                 .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"Telnet reception error"</span>)
<a name="l00618"></a>00618                 .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec de réception en telnet"</span>);
<a name="l00619"></a>00619             <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_SERVER, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"select() failed, errno = "</span> &lt;&lt; socket_errno &lt;&lt; endl;
<a name="l00620"></a>00620             <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471e42682039e1a584113718465a202d0c0">NULL_KEY</a>;
<a name="l00621"></a>00621         }
<a name="l00622"></a>00622     }
<a name="l00623"></a>00623     <span class="keywordflow">if</span> (b_ReceiveCharacters)
<a name="l00624"></a>00624     {
<a name="l00625"></a>00625         <span class="keywordflow">if</span> (! <a class="code" href="classTelnetConnection.html#7f04cc2f8f6c861760807da8556ec008">ReceiveChars</a>())
<a name="l00626"></a>00626         {
<a name="l00627"></a>00627             <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471e42682039e1a584113718465a202d0c0">NULL_KEY</a>;
<a name="l00628"></a>00628         }
<a name="l00629"></a>00629     }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631     <span class="comment">// Process characters</span>
<a name="l00632"></a>00632     <span class="keywordflow">if</span> (! m_qChars.IsEmpty())
<a name="l00633"></a>00633     {
<a name="l00634"></a>00634         <span class="comment">// Dequeue the received characters</span>
<a name="l00635"></a>00635         <span class="keyword">const</span> <span class="keywordtype">int</span> i_Front = m_qChars.RemoveHead();
<a name="l00636"></a>00636         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"i_Char = "</span> &lt;&lt; (char) i_Front &lt;&lt; <span class="stringliteral">" ("</span> &lt;&lt; i_Front &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
<a name="l00637"></a>00637 
<a name="l00638"></a>00638         <span class="comment">// Special character management.</span>
<a name="l00639"></a>00639         <span class="keywordflow">switch</span> (i_Front)
<a name="l00640"></a>00640         {
<a name="l00641"></a>00641         <span class="keywordflow">case</span> 1:     <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471eed3bac3a74a2eaf9a84d1a9774b67c1">KEY_BEGIN</a>;   <span class="comment">// CTRL+A</span>
<a name="l00642"></a>00642         <span class="keywordflow">case</span> 3:     <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc2704719524d094809858b9e4f778763913568a">BREAK</a>;       <span class="comment">// CTRL+C</span>
<a name="l00643"></a>00643         <span class="keywordflow">case</span> 4:     <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc27047186d6ca369e69a3a0f0c9bd063dd39a70">LOGOUT</a>;      <span class="comment">// CTRL+D</span>
<a name="l00644"></a>00644         <span class="keywordflow">case</span> 5:     <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471a8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>;     <span class="comment">// CTRL+E</span>
<a name="l00645"></a>00645         <span class="keywordflow">case</span> 8:     <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471d2534cebcf6f430484b7c931dd657ddc">BACKSPACE</a>;   <span class="comment">// CTRL+H</span>
<a name="l00646"></a>00646         <span class="keywordflow">case</span> 13:
<a name="l00647"></a>00647             <span class="keywordflow">if</span> (! m_qChars.IsEmpty())
<a name="l00648"></a>00648             {
<a name="l00649"></a>00649                 <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"i_Char2 = "</span> &lt;&lt; (char) m_qChars.GetHead() &lt;&lt; <span class="stringliteral">" ("</span> &lt;&lt; m_qChars.GetHead() &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
<a name="l00650"></a>00650                 <span class="keywordflow">if</span> (m_qChars.GetHead() == 10)
<a name="l00651"></a>00651                 {
<a name="l00652"></a>00652                     <span class="comment">// Process only the character 13 when the sequence is 13-10.</span>
<a name="l00653"></a>00653                     m_qChars.RemoveHead();
<a name="l00654"></a>00654                     <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471951ab68bb8f7daafb78951107080904e">ENTER</a>;
<a name="l00655"></a>00655                 }
<a name="l00656"></a>00656             }
<a name="l00657"></a>00657             <span class="keywordflow">break</span>;
<a name="l00658"></a>00658         <span class="keywordflow">case</span> 12:    <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471a5e0d06ffc1b0ee32eda539e6528a3e6">CLS</a>;         <span class="comment">// CTRL+L</span>
<a name="l00659"></a>00659         <span class="keywordflow">case</span> 14:    <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471b13b96bf99a409e019f70dc1602532fd">NEXT</a>;        <span class="comment">// CTRL+N</span>
<a name="l00660"></a>00660         <span class="keywordflow">case</span> 16:    <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471d9600a436d5cc272dfd53f6c45fdeca4">PREVIOUS</a>;    <span class="comment">// CTRL+P</span>
<a name="l00661"></a>00661         <span class="keywordflow">case</span> 25:    <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471d20f1b79e9cfc073db19741638050449">REDO</a>;        <span class="comment">// CTRL+Y</span>
<a name="l00662"></a>00662         <span class="keywordflow">case</span> 26:    <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc27047122a937c23ef109ac28176b98dacad9c6">UNDO</a>;        <span class="comment">// CTRL+Z</span>
<a name="l00663"></a>00663         <span class="keywordflow">case</span> 27:
<a name="l00664"></a>00664             <span class="keywordflow">if</span> (! m_qChars.IsEmpty())
<a name="l00665"></a>00665             {
<a name="l00666"></a>00666                 <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"i_Char2 = "</span> &lt;&lt; (char) m_qChars.GetHead() &lt;&lt; <span class="stringliteral">" ("</span> &lt;&lt; m_qChars.GetHead() &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
<a name="l00667"></a>00667                 <span class="keywordflow">if</span> (m_qChars.GetHead() == 91)
<a name="l00668"></a>00668                 {
<a name="l00669"></a>00669                     m_qChars.RemoveHead();
<a name="l00670"></a>00670 
<a name="l00671"></a>00671                     <span class="keywordflow">if</span> (! m_qChars.IsEmpty())
<a name="l00672"></a>00672                     {
<a name="l00673"></a>00673                         <span class="keyword">const</span> <span class="keywordtype">int</span> i_Special = m_qChars.RemoveHead();
<a name="l00674"></a>00674                         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"i_Char3 = "</span> &lt;&lt; (char) i_Special &lt;&lt; <span class="stringliteral">" ("</span> &lt;&lt; i_Special &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676                         <span class="keywordflow">switch</span> (i_Special)
<a name="l00677"></a>00677                         {
<a name="l00678"></a>00678                         <span class="comment">// All characters that will be followed by a 126 character.</span>
<a name="l00679"></a>00679                         <span class="keywordflow">case</span> 49: <span class="comment">// INSERT</span>
<a name="l00680"></a>00680                         <span class="keywordflow">case</span> 50: <span class="comment">// KEY_BEGIN;</span>
<a name="l00681"></a>00681                         <span class="keywordflow">case</span> 51: <span class="comment">// PAGE_UP;</span>
<a name="l00682"></a>00682                         <span class="keywordflow">case</span> 52: <span class="comment">// DELETE;</span>
<a name="l00683"></a>00683                         <span class="keywordflow">case</span> 53: <span class="comment">// KEY_END;</span>
<a name="l00684"></a>00684                         <span class="keywordflow">case</span> 54: <span class="comment">// PAGE_DOWN;</span>
<a name="l00685"></a>00685                             <span class="keywordflow">if</span> (! m_qChars.IsEmpty())
<a name="l00686"></a>00686                             {
<a name="l00687"></a>00687                                 <span class="keyword">const</span> <span class="keywordtype">int</span> i_Finish = m_qChars.RemoveHead();
<a name="l00688"></a>00688                                 <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"i_Char4 = "</span> &lt;&lt; (char) i_Finish &lt;&lt; <span class="stringliteral">" ("</span> &lt;&lt; i_Finish &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690                                 <span class="keywordflow">if</span> (i_Finish == 126)
<a name="l00691"></a>00691                                 {
<a name="l00692"></a>00692                                     <span class="keywordflow">switch</span> (i_Special)
<a name="l00693"></a>00693                                     {
<a name="l00694"></a>00694                                     <span class="keywordflow">case</span> 49: <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471a15c451953b2d2a93403afe786930d0f">INSERT</a>;
<a name="l00695"></a>00695                                     <span class="keywordflow">case</span> 50: <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471eed3bac3a74a2eaf9a84d1a9774b67c1">KEY_BEGIN</a>;
<a name="l00696"></a>00696                                     <span class="keywordflow">case</span> 51: <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc2704710442824c041b9618cd7c512205e7e6dc">PAGE_UP</a>;
<a name="l00697"></a>00697                                     <span class="keywordflow">case</span> 52: <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc2704719d61e82a9a12752f10aece1b22183913">DELETE</a>;
<a name="l00698"></a>00698                                     <span class="keywordflow">case</span> 53: <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471a8adb6fcb92dec58fb19410eacfdd403">KEY_END</a>;
<a name="l00699"></a>00699                                     <span class="keywordflow">case</span> 54: <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471714c5d27586a8bcbab274d9176da1539">PAGE_DOWN</a>;
<a name="l00700"></a>00700                                     }
<a name="l00701"></a>00701                                 }
<a name="l00702"></a>00702                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i_Special == 49) &amp;&amp; (! m_qChars.IsEmpty()))
<a name="l00703"></a>00703                                 {
<a name="l00704"></a>00704                                     <span class="comment">// Function keys.</span>
<a name="l00705"></a>00705                                     <span class="keyword">const</span> <span class="keywordtype">int</span> i_Function = i_Finish;
<a name="l00706"></a>00706                                     <span class="keyword">const</span> <span class="keywordtype">int</span> i_FunctionFinish = m_qChars.RemoveHead();
<a name="l00707"></a>00707                                     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"i_Char5 = "</span> &lt;&lt; (char) i_FunctionFinish &lt;&lt; <span class="stringliteral">" ("</span> &lt;&lt; i_FunctionFinish &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
<a name="l00708"></a>00708 
<a name="l00709"></a>00709                                     <span class="keywordflow">if</span> (i_FunctionFinish == 126)
<a name="l00710"></a>00710                                     {
<a name="l00711"></a>00711                                         <span class="keywordflow">switch</span> (i_Function)
<a name="l00712"></a>00712                                         {
<a name="l00713"></a>00713                                         <span class="keywordflow">case</span> 49: <span class="keywordflow">return</span> F1;
<a name="l00714"></a>00714                                         <span class="keywordflow">case</span> 50: <span class="keywordflow">return</span> F2;
<a name="l00715"></a>00715                                         <span class="keywordflow">case</span> 51: <span class="keywordflow">return</span> F3;
<a name="l00716"></a>00716                                         <span class="keywordflow">case</span> 52: <span class="keywordflow">return</span> F4;
<a name="l00717"></a>00717                                         <span class="keywordflow">case</span> 53: <span class="keywordflow">return</span> F5;
<a name="l00718"></a>00718                                         <span class="keywordflow">case</span> 55: <span class="keywordflow">return</span> F6;
<a name="l00719"></a>00719                                         <span class="keywordflow">case</span> 56: <span class="keywordflow">return</span> F7;
<a name="l00720"></a>00720                                         <span class="keywordflow">case</span> 57: <span class="keywordflow">return</span> F8;
<a name="l00721"></a>00721                                         }
<a name="l00722"></a>00722                                     }
<a name="l00723"></a>00723 
<a name="l00724"></a>00724                                     <span class="comment">// Unhandled.</span>
<a name="l00725"></a>00725                                     <span class="keywordflow">if</span> (! m_qChars.AddHead(i_FunctionFinish))
<a name="l00726"></a>00726                                     {
<a name="l00727"></a>00727                                         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(<a class="code" href="traces_8h.html#243b1b1f8ca7e7e98ac73a2d115256f4">INTERNAL_ERROR</a>, *<span class="keyword">this</span>)
<a name="l00728"></a>00728                                             &lt;&lt; <span class="stringliteral">"TelnetConnection::GetKey(): "</span>
<a name="l00729"></a>00729                                             &lt;&lt; <span class="stringliteral">"Unable to restore previously removed character from m_qChars"</span>
<a name="l00730"></a>00730                                             &lt;&lt; endl;
<a name="l00731"></a>00731                                     }
<a name="l00732"></a>00732                                 }
<a name="l00733"></a>00733                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i_Special == 50) &amp;&amp; (! m_qChars.IsEmpty()))
<a name="l00734"></a>00734                                 {
<a name="l00735"></a>00735                                     <span class="comment">// Function keys.</span>
<a name="l00736"></a>00736                                     <span class="keyword">const</span> <span class="keywordtype">int</span> i_Function = i_Finish;
<a name="l00737"></a>00737                                     <span class="keyword">const</span> <span class="keywordtype">int</span> i_FunctionFinish = m_qChars.RemoveHead();
<a name="l00738"></a>00738                                     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_IN, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"i_Char5 = "</span> &lt;&lt; (char) i_FunctionFinish &lt;&lt; <span class="stringliteral">" ("</span> &lt;&lt; i_FunctionFinish &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
<a name="l00739"></a>00739 
<a name="l00740"></a>00740                                     <span class="keywordflow">if</span> (i_FunctionFinish == 126)
<a name="l00741"></a>00741                                     {
<a name="l00742"></a>00742                                         <span class="keywordflow">switch</span> (i_Function)
<a name="l00743"></a>00743                                         {
<a name="l00744"></a>00744                                         <span class="keywordflow">case</span> 48: <span class="keywordflow">return</span> F9;
<a name="l00745"></a>00745                                         <span class="keywordflow">case</span> 49: <span class="keywordflow">return</span> F10;
<a name="l00746"></a>00746                                         <span class="keywordflow">case</span> 51: <span class="keywordflow">return</span> F11;
<a name="l00747"></a>00747                                         <span class="keywordflow">case</span> 52: <span class="keywordflow">return</span> F12;
<a name="l00748"></a>00748                                         }
<a name="l00749"></a>00749                                     }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751                                     <span class="comment">// Unhandled.</span>
<a name="l00752"></a>00752                                     <span class="keywordflow">if</span> (! m_qChars.AddHead(i_FunctionFinish))
<a name="l00753"></a>00753                                     {
<a name="l00754"></a>00754                                         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(<a class="code" href="traces_8h.html#243b1b1f8ca7e7e98ac73a2d115256f4">INTERNAL_ERROR</a>, *<span class="keyword">this</span>)
<a name="l00755"></a>00755                                             &lt;&lt; <span class="stringliteral">"TelnetConnection::GetKey(): "</span>
<a name="l00756"></a>00756                                             &lt;&lt; <span class="stringliteral">"Unable to restore previously removed character from m_qChars"</span>
<a name="l00757"></a>00757                                             &lt;&lt; endl;
<a name="l00758"></a>00758                                     }
<a name="l00759"></a>00759                                 }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761                                 <span class="comment">// Unhandled.</span>
<a name="l00762"></a>00762                                 <span class="keywordflow">if</span> (! m_qChars.AddHead(i_Finish))
<a name="l00763"></a>00763                                 {
<a name="l00764"></a>00764                                     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(<a class="code" href="traces_8h.html#243b1b1f8ca7e7e98ac73a2d115256f4">INTERNAL_ERROR</a>, *<span class="keyword">this</span>)
<a name="l00765"></a>00765                                         &lt;&lt; <span class="stringliteral">"TelnetConnection::GetKey(): "</span>
<a name="l00766"></a>00766                                         &lt;&lt; <span class="stringliteral">"Unable to restore previously removed character from m_qChars"</span>
<a name="l00767"></a>00767                                         &lt;&lt; endl;
<a name="l00768"></a>00768                                 }
<a name="l00769"></a>00769                             }
<a name="l00770"></a>00770                         <span class="keywordflow">case</span> 65: <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc2704710848a442d907968b211b97bc2bd88acd">KEY_UP</a>;
<a name="l00771"></a>00771                         <span class="keywordflow">case</span> 66: <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471a9cdac7967bf7d88fdb761138a2a3416">KEY_DOWN</a>;
<a name="l00772"></a>00772                         <span class="keywordflow">case</span> 67: <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc2704716504370d9c6391e1a9da6a1a529b089d">KEY_RIGHT</a>;
<a name="l00773"></a>00773                         <span class="keywordflow">case</span> 68: <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471612120b69c7dfd46086db7aaebdbcf65">KEY_LEFT</a>;
<a name="l00774"></a>00774                         }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776                         <span class="comment">// Unhandled.</span>
<a name="l00777"></a>00777                         <span class="keywordflow">if</span> (! m_qChars.AddHead(i_Special))
<a name="l00778"></a>00778                         {
<a name="l00779"></a>00779                             <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(<a class="code" href="traces_8h.html#243b1b1f8ca7e7e98ac73a2d115256f4">INTERNAL_ERROR</a>, *<span class="keyword">this</span>)
<a name="l00780"></a>00780                                 &lt;&lt; <span class="stringliteral">"TelnetConnection::GetKey(): "</span>
<a name="l00781"></a>00781                                 &lt;&lt; <span class="stringliteral">"Unable to restore previously removed character from m_qChars"</span>
<a name="l00782"></a>00782                                 &lt;&lt; endl;
<a name="l00783"></a>00783                         }
<a name="l00784"></a>00784                     }
<a name="l00785"></a>00785 
<a name="l00786"></a>00786                     <span class="comment">// Unhandled.</span>
<a name="l00787"></a>00787                     <span class="keywordflow">if</span> (! m_qChars.AddHead(91))
<a name="l00788"></a>00788                     {
<a name="l00789"></a>00789                         <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(<a class="code" href="traces_8h.html#243b1b1f8ca7e7e98ac73a2d115256f4">INTERNAL_ERROR</a>, *<span class="keyword">this</span>)
<a name="l00790"></a>00790                             &lt;&lt; <span class="stringliteral">"TelnetConnection::GetKey(): "</span>
<a name="l00791"></a>00791                             &lt;&lt; <span class="stringliteral">"Unable to restore previously removed character from m_qChars"</span>
<a name="l00792"></a>00792                             &lt;&lt; endl;
<a name="l00793"></a>00793                     }
<a name="l00794"></a>00794                 }
<a name="l00795"></a>00795             }
<a name="l00796"></a>00796             <span class="keywordflow">else</span>
<a name="l00797"></a>00797             {
<a name="l00798"></a>00798                 <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc2704710a311695a4f6c56869245418bebeb33d">ESCAPE</a>;
<a name="l00799"></a>00799             }
<a name="l00800"></a>00800             <span class="keywordflow">break</span>;
<a name="l00801"></a>00801         <span class="keywordflow">case</span> 96:    <span class="keywordflow">return</span> BACK_QUOTE;
<a name="l00802"></a>00802         <span class="keywordflow">case</span> 126:   <span class="keywordflow">return</span> TILDE;
<a name="l00803"></a>00803         <span class="keywordflow">case</span> 127:   <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc2704719d61e82a9a12752f10aece1b22183913">DELETE</a>;
<a name="l00804"></a>00804 
<a name="l00805"></a>00805         <span class="comment">// Accentuated characters.</span>
<a name="l00806"></a>00806         <span class="keywordflow">case</span> -31:   <span class="keywordflow">return</span> KEY_aacute;
<a name="l00807"></a>00807         <span class="keywordflow">case</span> -32:   <span class="keywordflow">return</span> KEY_agrave;
<a name="l00808"></a>00808         <span class="keywordflow">case</span> -28:   <span class="keywordflow">return</span> KEY_auml;
<a name="l00809"></a>00809         <span class="keywordflow">case</span> -30:   <span class="keywordflow">return</span> KEY_acirc;
<a name="l00810"></a>00810         <span class="keywordflow">case</span> -25:   <span class="keywordflow">return</span> KEY_ccedil;
<a name="l00811"></a>00811         <span class="keywordflow">case</span> -23:   <span class="keywordflow">return</span> KEY_eacute;
<a name="l00812"></a>00812         <span class="keywordflow">case</span> -24:   <span class="keywordflow">return</span> KEY_egrave;
<a name="l00813"></a>00813         <span class="keywordflow">case</span> -21:   <span class="keywordflow">return</span> KEY_euml;
<a name="l00814"></a>00814         <span class="keywordflow">case</span> -22:   <span class="keywordflow">return</span> KEY_ecirc;
<a name="l00815"></a>00815         <span class="keywordflow">case</span> -19:   <span class="keywordflow">return</span> KEY_iacute;
<a name="l00816"></a>00816         <span class="keywordflow">case</span> -20:   <span class="keywordflow">return</span> KEY_igrave;
<a name="l00817"></a>00817         <span class="keywordflow">case</span> -17:   <span class="keywordflow">return</span> KEY_iuml;
<a name="l00818"></a>00818         <span class="keywordflow">case</span> -18:   <span class="keywordflow">return</span> KEY_icirc;
<a name="l00819"></a>00819         <span class="keywordflow">case</span> -13:   <span class="keywordflow">return</span> KEY_oacute;
<a name="l00820"></a>00820         <span class="keywordflow">case</span> -14:   <span class="keywordflow">return</span> KEY_ograve;
<a name="l00821"></a>00821         <span class="keywordflow">case</span> -10:   <span class="keywordflow">return</span> KEY_ouml;
<a name="l00822"></a>00822         <span class="keywordflow">case</span> -12:   <span class="keywordflow">return</span> KEY_ocirc;
<a name="l00823"></a>00823         <span class="keywordflow">case</span> -6:    <span class="keywordflow">return</span> KEY_uacute;
<a name="l00824"></a>00824         <span class="keywordflow">case</span> -7:    <span class="keywordflow">return</span> KEY_ugrave;
<a name="l00825"></a>00825         <span class="keywordflow">case</span> -4:    <span class="keywordflow">return</span> KEY_uuml;
<a name="l00826"></a>00826         <span class="keywordflow">case</span> -5:    <span class="keywordflow">return</span> KEY_ucirc;
<a name="l00827"></a>00827         <span class="comment">// Accentuated characters copied from the output itself.</span>
<a name="l00828"></a>00828         <span class="keywordflow">case</span> -96:   <span class="keywordflow">return</span> KEY_aacute;
<a name="l00829"></a>00829         <span class="keywordflow">case</span> -123:  <span class="keywordflow">return</span> KEY_agrave;
<a name="l00830"></a>00830         <span class="keywordflow">case</span> -124:  <span class="keywordflow">return</span> KEY_auml;
<a name="l00831"></a>00831         <span class="keywordflow">case</span> -125:  <span class="keywordflow">return</span> KEY_acirc;
<a name="l00832"></a>00832         <span class="keywordflow">case</span> -121:  <span class="keywordflow">return</span> KEY_ccedil;
<a name="l00833"></a>00833         <span class="keywordflow">case</span> -126:  <span class="keywordflow">return</span> KEY_eacute;
<a name="l00834"></a>00834         <span class="keywordflow">case</span> -118:  <span class="keywordflow">return</span> KEY_egrave;
<a name="l00835"></a>00835         <span class="keywordflow">case</span> -119:  <span class="keywordflow">return</span> KEY_euml;
<a name="l00836"></a>00836         <span class="keywordflow">case</span> -120:  <span class="keywordflow">return</span> KEY_ecirc;
<a name="l00837"></a>00837         <span class="keywordflow">case</span> -95:   <span class="keywordflow">return</span> KEY_iacute;
<a name="l00838"></a>00838         <span class="keywordflow">case</span> -115:  <span class="keywordflow">return</span> KEY_igrave;
<a name="l00839"></a>00839         <span class="keywordflow">case</span> -117:  <span class="keywordflow">return</span> KEY_iuml;
<a name="l00840"></a>00840         <span class="keywordflow">case</span> -116:  <span class="keywordflow">return</span> KEY_icirc;
<a name="l00841"></a>00841         <span class="keywordflow">case</span> -94:   <span class="keywordflow">return</span> KEY_oacute;
<a name="l00842"></a>00842         <span class="keywordflow">case</span> -107:  <span class="keywordflow">return</span> KEY_ograve;
<a name="l00843"></a>00843         <span class="keywordflow">case</span> -108:  <span class="keywordflow">return</span> KEY_ouml;
<a name="l00844"></a>00844         <span class="keywordflow">case</span> -109:  <span class="keywordflow">return</span> KEY_ocirc;
<a name="l00845"></a>00845         <span class="comment">//case -93:   return KEY_uacute;    // Conflicts with POUND!</span>
<a name="l00846"></a>00846         <span class="keywordflow">case</span> -105:  <span class="keywordflow">return</span> KEY_ugrave;
<a name="l00847"></a>00847         <span class="keywordflow">case</span> -127:  <span class="keywordflow">return</span> KEY_uuml;
<a name="l00848"></a>00848         <span class="keywordflow">case</span> -106:  <span class="keywordflow">return</span> KEY_ucirc;
<a name="l00849"></a>00849 
<a name="l00850"></a>00850         <span class="comment">// Special characters.</span>
<a name="l00851"></a>00851         <span class="keywordflow">case</span> -75:   <span class="keywordflow">return</span> MICRO;
<a name="l00852"></a>00852         <span class="keywordflow">case</span> -26:   <span class="keywordflow">return</span> MICRO;       <span class="comment">// Copied from the output itself.</span>
<a name="l00853"></a>00853         <span class="keywordflow">case</span> -78:   <span class="keywordflow">return</span> SQUARE;
<a name="l00854"></a>00854         <span class="keywordflow">case</span> -3:    <span class="keywordflow">return</span> SQUARE;      <span class="comment">// Copied from the output itself.</span>
<a name="l00855"></a>00855         <span class="keywordflow">case</span> -80:   <span class="keywordflow">return</span> DEGREE;
<a name="l00856"></a>00856         <span class="keywordflow">case</span> -8:    <span class="keywordflow">return</span> DEGREE;      <span class="comment">// Copied from the output itself.</span>
<a name="l00857"></a>00857         <span class="keywordflow">case</span> -87:   <span class="keywordflow">return</span> COPYRIGHT;
<a name="l00858"></a>00858         <span class="keywordflow">case</span> -72:   <span class="keywordflow">return</span> COPYRIGHT;   <span class="comment">// Copied from the output itself.</span>
<a name="l00859"></a>00859         <span class="keywordflow">case</span> -89:   <span class="keywordflow">return</span> PARAGRAPH;
<a name="l00860"></a>00860         <span class="keywordflow">case</span> -11:   <span class="keywordflow">return</span> PARAGRAPH;   <span class="comment">// Copied from the output itself.</span>
<a name="l00861"></a>00861         <span class="keywordflow">case</span> -93:   <span class="keywordflow">return</span> POUND;
<a name="l00862"></a>00862         <span class="keywordflow">case</span> -100:  <span class="keywordflow">return</span> POUND;       <span class="comment">// Copied from the output itself.</span>
<a name="l00863"></a>00863         <span class="keywordflow">case</span> -128:  <span class="keywordflow">return</span> EURO;
<a name="l00864"></a>00864         <span class="keywordflow">case</span> -79:   <span class="keywordflow">return</span> EURO;    <span class="comment">// Copied from the output itself.</span>
<a name="l00865"></a>00865         }
<a name="l00866"></a>00866 
<a name="l00867"></a>00867         <span class="comment">// Unhandled</span>
<a name="l00868"></a>00868         <span class="comment">// Use default behaviour.</span>
<a name="l00869"></a>00869         <span class="keyword">const</span> <a class="code" href="io__device_8h.html#90d295cf6b6bc9873c186cc8851147f8">KEY</a> e_Char = <a class="code" href="classIODevice.html#7bafac5c500746f742aa289f33e38feb">IODevice::GetKey</a>(i_Front);
<a name="l00870"></a>00870         <span class="keywordflow">if</span> (e_Char != <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471e42682039e1a584113718465a202d0c0">NULL_KEY</a>)
<a name="l00871"></a>00871         {
<a name="l00872"></a>00872             <span class="keywordflow">return</span> e_Char;
<a name="l00873"></a>00873         }
<a name="l00874"></a>00874         <span class="keywordflow">else</span>
<a name="l00875"></a>00875         {
<a name="l00876"></a>00876             <span class="comment">// Unknown character.</span>
<a name="l00877"></a>00877             <span class="keywordflow">return</span> <a class="code" href="classTelnetConnection.html#e3858fcf54afc30be3a18370b0623eac">GetKey</a>();
<a name="l00878"></a>00878         }
<a name="l00879"></a>00879     }
<a name="l00880"></a>00880 
<a name="l00881"></a>00881     <span class="keywordflow">return</span> <a class="code" href="io__device_8h.html#87c1c1677bb8199c62a3de0ebc270471e42682039e1a584113718465a202d0c0">NULL_KEY</a>;
<a name="l00882"></a>00882 }
<a name="l00883"></a>00883 
<a name="l00884"></a>00884 <span class="keywordtype">void</span> <a class="code" href="classTelnetConnection.html#24ac224b53c4a456be846f847738b26e">TelnetConnection::OnKey</a>(<span class="keyword">const</span> <a class="code" href="io__device_8h.html#90d295cf6b6bc9873c186cc8851147f8">KEY</a> E_Key)<span class="keyword"> const</span>
<a name="l00885"></a>00885 <span class="keyword"></span>{
<a name="l00886"></a>00886     <span class="keywordflow">if</span> (m_bWaitingForKeys)
<a name="l00887"></a>00887     {
<a name="l00888"></a>00888         m_bWaitingForKeys = <span class="keyword">false</span>;
<a name="l00889"></a>00889     }
<a name="l00890"></a>00890     <a class="code" href="classNonBlockingIODevice.html#e7f95aa8e13de4a2b4a271da01b19db2">NonBlockingIODevice::OnKey</a>(E_Key);
<a name="l00891"></a>00891 }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893 <span class="keyword">const</span> <span class="keywordtype">bool</span> <a class="code" href="classTelnetConnection.html#b161e4f062a73244c3db605d49f48d4e">TelnetConnection::WaitForKeys</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> UI_Milli)<span class="keyword"> const</span>
<a name="l00894"></a>00894 <span class="keyword"></span>{
<a name="l00895"></a>00895     <span class="keywordflow">if</span> (! m_qChars.IsEmpty())
<a name="l00896"></a>00896     {
<a name="l00897"></a>00897         <span class="keyword">const</span> <a class="code" href="io__device_8h.html#90d295cf6b6bc9873c186cc8851147f8">KEY</a> e_Key = <a class="code" href="classTelnetConnection.html#e3858fcf54afc30be3a18370b0623eac">GetKey</a>();
<a name="l00898"></a>00898         <a class="code" href="classTelnetConnection.html#24ac224b53c4a456be846f847738b26e">OnKey</a>(e_Key);
<a name="l00899"></a>00899         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00900"></a>00900     }
<a name="l00901"></a>00901     <span class="keywordflow">else</span>
<a name="l00902"></a>00902     {
<a name="l00903"></a>00903         time_t t0 = time(NULL);
<a name="l00904"></a>00904         <span class="keywordflow">for</span> (m_bWaitingForKeys = <span class="keyword">true</span>; m_bWaitingForKeys &amp;&amp; (time(NULL) - t0 &lt; (time_t) UI_Milli); )
<a name="l00905"></a>00905         {
<a name="l00906"></a>00906             <span class="keywordflow">if</span> (m_pcliServer != NULL)
<a name="l00907"></a>00907             {
<a name="l00908"></a>00908                 <span class="keyword">const</span> time_t t_Passed = time(NULL) - t0;
<a name="l00909"></a>00909                 <span class="keyword">const</span> time_t t_Delay = (t_Passed &gt; (time_t) UI_Milli ? 0 : UI_Milli - t_Passed);
<a name="l00910"></a>00910                 m_pcliServer-&gt;<a class="code" href="classTelnetServer.html#a60ac196efb30fd0537c53c5ffcadc8d">RunLoop</a>((<span class="keywordtype">int</span>) t_Delay); <span class="comment">// cast to avoid warnings</span>
<a name="l00911"></a>00911             }
<a name="l00912"></a>00912             <span class="keywordflow">else</span>
<a name="l00913"></a>00913             {
<a name="l00914"></a>00914                 <a class="code" href="classTelnetConnection.html#7f04cc2f8f6c861760807da8556ec008">ReceiveChars</a>();
<a name="l00915"></a>00915                 <a class="code" href="classTelnetConnection.html#24edca24d831bfe1d5379fbdd2ec8db4">ProcessKeys</a>();
<a name="l00916"></a>00916             }
<a name="l00917"></a>00917         }
<a name="l00918"></a>00918         <span class="keywordflow">return</span> (! m_bWaitingForKeys);
<a name="l00919"></a>00919     }
<a name="l00920"></a>00920 }
<a name="l00921"></a>00921 
<a name="l00922"></a>00922 <span class="keywordtype">void</span> <a class="code" href="classTelnetConnection.html#df9a02cd4cd1fc24a6a3415b077ba736">TelnetConnection::PutString</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* <span class="keyword">const</span> STR_Out)<span class="keyword"> const</span>
<a name="l00923"></a>00923 <span class="keyword"></span>{
<a name="l00924"></a>00924     <span class="keywordflow">if</span> (STR_Out != NULL)
<a name="l00925"></a>00925     {
<a name="l00926"></a>00926         <span class="keyword">const</span> <span class="keywordtype">int</span> i_InLen = (int) strlen(STR_Out);
<a name="l00927"></a>00927         <span class="keywordtype">int</span> i_OutLen = i_InLen;
<a name="l00928"></a>00928         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;i_InLen; i++) {
<a name="l00929"></a>00929             <span class="keywordflow">if</span> (STR_Out[i] == <span class="charliteral">'\n'</span>) {
<a name="l00930"></a>00930                 i_OutLen ++;
<a name="l00931"></a>00931             }
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933         <span class="keywordflow">if</span> (i_OutLen &gt; 0)
<a name="l00934"></a>00934         <span class="keywordflow">if</span> (<span class="keywordtype">char</span>* <span class="keyword">const</span> str_Out = <span class="keyword">new</span> <span class="keywordtype">char</span>[i_OutLen + 1])
<a name="l00935"></a>00935         {
<a name="l00936"></a>00936             memset(str_Out, <span class="charliteral">'\0'</span>, i_OutLen + 1);
<a name="l00937"></a>00937 
<a name="l00938"></a>00938             <span class="comment">// Conversions.</span>
<a name="l00939"></a>00939             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0, o=0; i&lt;i_InLen; i++)
<a name="l00940"></a>00940             {
<a name="l00941"></a>00941                 <span class="keywordflow">switch</span> (STR_Out[i])
<a name="l00942"></a>00942                 {
<a name="l00943"></a>00943                 <span class="keywordflow">case</span> KEY_aacute:    str_Out[o++] = (<span class="keywordtype">char</span>) -96;  <span class="keywordflow">break</span>;
<a name="l00944"></a>00944                 <span class="keywordflow">case</span> KEY_agrave:    str_Out[o++] = (char) -123; <span class="keywordflow">break</span>;
<a name="l00945"></a>00945                 <span class="keywordflow">case</span> KEY_auml:      str_Out[o++] = (char) -124; <span class="keywordflow">break</span>;
<a name="l00946"></a>00946                 <span class="keywordflow">case</span> KEY_acirc:     str_Out[o++] = (char) -125; <span class="keywordflow">break</span>;
<a name="l00947"></a>00947                 <span class="keywordflow">case</span> KEY_ccedil:    str_Out[o++] = (char) -121; <span class="keywordflow">break</span>;
<a name="l00948"></a>00948                 <span class="keywordflow">case</span> KEY_eacute:    str_Out[o++] = (char) -126; <span class="keywordflow">break</span>;
<a name="l00949"></a>00949                 <span class="keywordflow">case</span> KEY_egrave:    str_Out[o++] = (char) -118; <span class="keywordflow">break</span>;
<a name="l00950"></a>00950                 <span class="keywordflow">case</span> KEY_euml:      str_Out[o++] = (char) -119; <span class="keywordflow">break</span>;
<a name="l00951"></a>00951                 <span class="keywordflow">case</span> KEY_ecirc:     str_Out[o++] = (char) -120; <span class="keywordflow">break</span>;
<a name="l00952"></a>00952                 <span class="keywordflow">case</span> KEY_iacute:    str_Out[o++] = (char) -95;  <span class="keywordflow">break</span>;
<a name="l00953"></a>00953                 <span class="keywordflow">case</span> KEY_igrave:    str_Out[o++] = (char) -115; <span class="keywordflow">break</span>;
<a name="l00954"></a>00954                 <span class="keywordflow">case</span> KEY_iuml:      str_Out[o++] = (char) -117; <span class="keywordflow">break</span>;
<a name="l00955"></a>00955                 <span class="keywordflow">case</span> KEY_icirc:     str_Out[o++] = (char) -116; <span class="keywordflow">break</span>;
<a name="l00956"></a>00956                 <span class="keywordflow">case</span> KEY_oacute:    str_Out[o++] = (char) -94;  <span class="keywordflow">break</span>;
<a name="l00957"></a>00957                 <span class="keywordflow">case</span> KEY_ograve:    str_Out[o++] = (char) -107; <span class="keywordflow">break</span>;
<a name="l00958"></a>00958                 <span class="keywordflow">case</span> KEY_ouml:      str_Out[o++] = (char) -108; <span class="keywordflow">break</span>;
<a name="l00959"></a>00959                 <span class="keywordflow">case</span> KEY_ocirc:     str_Out[o++] = (char) -109; <span class="keywordflow">break</span>;
<a name="l00960"></a>00960                 <span class="keywordflow">case</span> KEY_uacute:    str_Out[o++] = (char) -93;  <span class="keywordflow">break</span>;
<a name="l00961"></a>00961                 <span class="keywordflow">case</span> KEY_ugrave:    str_Out[o++] = (char) -105; <span class="keywordflow">break</span>;
<a name="l00962"></a>00962                 <span class="keywordflow">case</span> KEY_uuml:      str_Out[o++] = (char) -127; <span class="keywordflow">break</span>;
<a name="l00963"></a>00963                 <span class="keywordflow">case</span> KEY_ucirc:     str_Out[o++] = (char) -106; <span class="keywordflow">break</span>;
<a name="l00964"></a>00964                 <span class="keywordflow">case</span> SQUARE:        str_Out[o++] = (char) -3;   <span class="keywordflow">break</span>;
<a name="l00965"></a>00965                 <span class="keywordflow">case</span> EURO:          str_Out[o++] = (char) -79;  <span class="keywordflow">break</span>;
<a name="l00966"></a>00966                 <span class="keywordflow">case</span> POUND:         str_Out[o++] = (char) -100; <span class="keywordflow">break</span>;
<a name="l00967"></a>00967                 <span class="keywordflow">case</span> MICRO:         str_Out[o++] = (char) -26;  <span class="keywordflow">break</span>;
<a name="l00968"></a>00968                 <span class="keywordflow">case</span> PARAGRAPH:     str_Out[o++] = (char) -11;  <span class="keywordflow">break</span>;
<a name="l00969"></a>00969                 <span class="keywordflow">case</span> DEGREE:        str_Out[o++] = (char) -8;   <span class="keywordflow">break</span>;
<a name="l00970"></a>00970                 <span class="keywordflow">case</span> COPYRIGHT:     str_Out[o++] = (char) -72;  <span class="keywordflow">break</span>;
<a name="l00971"></a>00971                 <span class="keywordflow">case</span> <span class="charliteral">'\n'</span>:          str_Out[o++] = <span class="charliteral">'\r'</span>; str_Out[o++] = <span class="charliteral">'\n'</span>; <span class="keywordflow">break</span>;
<a name="l00972"></a>00972                 <span class="keywordflow">default</span>:            str_Out[o++] = STR_Out[i];  <span class="keywordflow">break</span>;
<a name="l00973"></a>00973                 }
<a name="l00974"></a>00974             }
<a name="l00975"></a>00975 
<a name="l00976"></a>00976             <span class="comment">// Send the buffer.</span>
<a name="l00977"></a>00977             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> r=0; r&lt;i_OutLen; r++)
<a name="l00978"></a>00978             {
<a name="l00979"></a>00979                 <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().SafeTrace(CLI_TELNET_OUT, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"sending "</span> &lt;&lt; (<span class="keywordtype">char</span>) str_Out[r] &lt;&lt; endl;
<a name="l00980"></a>00980             }
<a name="l00981"></a>00981             <span class="keyword">const</span> <span class="keywordtype">int</span> i_Len = send(m_iSocket, str_Out, i_OutLen, 0);
<a name="l00982"></a>00982             <span class="keywordflow">if</span> (i_Len != i_OutLen)
<a name="l00983"></a>00983             {
<a name="l00984"></a>00984                 <a class="code" href="classOutputDevice.html#c831dff60351f1a3dffd667e175e8f23">m_cliLastError</a>
<a name="l00985"></a>00985                     .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3f12fbeaebaa487c3970ecc2cf837e0df">ResourceString::LANG_EN</a>, <span class="stringliteral">"Telnet emission error"</span>)
<a name="l00986"></a>00986                     .<a class="code" href="classResourceString.html#7a475c727ce2d3b13a4ce609032a0a8a">SetString</a>(<a class="code" href="classResourceString.html#88d585d899c8482aeb434571923739b3142a22fb5f61fe5c723693b4cc887f4f">ResourceString::LANG_FR</a>, <span class="stringliteral">"Echec d'émission en telnet"</span>);
<a name="l00987"></a>00987 
<a name="l00988"></a>00988                 <span class="keywordflow">if</span> (i_Len &lt; 0)
<a name="l00989"></a>00989                 {
<a name="l00990"></a>00990                     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_OUT, *<span class="keyword">this</span>) &lt;&lt; <span class="stringliteral">"send failed"</span> &lt;&lt; endl;
<a name="l00991"></a>00991                 }
<a name="l00992"></a>00992                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i_Len &lt; i_OutLen)
<a name="l00993"></a>00993                 {
<a name="l00994"></a>00994                     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_OUT, *<span class="keyword">this</span>)
<a name="l00995"></a>00995                         &lt;&lt; <span class="stringliteral">"send incomplete"</span>
<a name="l00996"></a>00996                         &lt;&lt; <span class="stringliteral">" (only "</span> &lt;&lt; i_Len &lt;&lt; <span class="stringliteral">" characters sent"</span>
<a name="l00997"></a>00997                         &lt;&lt; <span class="stringliteral">" over "</span> &lt;&lt; i_OutLen &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
<a name="l00998"></a>00998                 }
<a name="l00999"></a>00999                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i_Len &gt; i_OutLen)
<a name="l01000"></a>01000                 {
<a name="l01001"></a>01001                     <a class="code" href="traces_8h.html#757ce8f9014dd17ed7349efcdd702af9">GetTraces</a>().<a class="code" href="classTraces.html#99fe59fe9cb9e5183b245623c2a240a8">SafeTrace</a>(CLI_TELNET_OUT, *<span class="keyword">this</span>)
<a name="l01002"></a>01002                         &lt;&lt; <span class="stringliteral">"strange send return value"</span>
<a name="l01003"></a>01003                         &lt;&lt; <span class="stringliteral">" ("</span> &lt;&lt; i_Len &lt;&lt; <span class="stringliteral">" for "</span> &lt;&lt; i_OutLen &lt;&lt; <span class="stringliteral">" characters sent)"</span> &lt;&lt; endl;
<a name="l01004"></a>01004                 }
<a name="l01005"></a>01005             }
<a name="l01006"></a>01006 
<a name="l01007"></a>01007             <span class="comment">// Free the local output buffer.</span>
<a name="l01008"></a>01008             <span class="keyword">delete</span> [] str_Out;
<a name="l01009"></a>01009         }
<a name="l01010"></a>01010     }
<a name="l01011"></a>01011 }
<a name="l01012"></a>01012 
<a name="l01013"></a>01013 <span class="keywordtype">void</span> <a class="code" href="classTelnetConnection.html#7fa4b5dbc540af6113fb297bee75e6d1">TelnetConnection::Beep</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span>
<a name="l01014"></a>01014 <span class="keyword"></span>{
<a name="l01015"></a>01015     <a class="code" href="classOutputDevice.html#4b4cc34728972042f3a79e5e63178b7b">NonBlockingIODevice::Beep</a>();
<a name="l01016"></a>01016 }
<a name="l01017"></a>01017 
<a name="l01018"></a>01018 <span class="keywordtype">void</span> <a class="code" href="classTelnetConnection.html#4e9a1888cb13e6e600da55935f35fbf5">TelnetConnection::CleanScreen</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span>
<a name="l01019"></a>01019 <span class="keyword"></span>{
<a name="l01020"></a>01020     <a class="code" href="classOutputDevice.html#04c4210231e603e0d398698885a9c5de">NonBlockingIODevice::CleanScreen</a>();
<a name="l01021"></a>01021 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Dec 12 23:20:28 2011 for CLI by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1 </small></address>
</body>
</html>
