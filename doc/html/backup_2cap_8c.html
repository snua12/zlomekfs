<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>zlomekFS: cap.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul>
</div>
<div class="nav">
<a class="el" href="dir_21c430ab3b7001ae39034eae6f7edf71.html">zfsd</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_ac94841c51e61ddc7acc56e12a771012.html">backup</a></div>
<h1>backup/cap.c File Reference</h1>Capability functions. <a href="#_details">More...</a>
<p>
<code>#include &quot;<a class="el" href="backup_2system_8h-source.html">system.h</a>&quot;</code><br>
<code>#include &lt;inttypes.h&gt;</code><br>
<code>#include &lt;sys/types.h&gt;</code><br>
<code>#include &lt;sys/stat.h&gt;</code><br>
<code>#include &lt;fcntl.h&gt;</code><br>
<code>#include &lt;errno.h&gt;</code><br>
<code>#include &lt;stdio.h&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include &quot;<a class="el" href="backup_2pthread-wrapper_8h-source.html">pthread-wrapper.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2cap_8h-source.html">cap.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2crc32_8h-source.html">crc32.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2md5_8h-source.html">md5.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2alloc-pool_8h-source.html">alloc-pool.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2hashtab_8h-source.html">hashtab.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2fh_8h-source.html">fh.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2dir_8h-source.html">dir.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2file_8h-source.html">file.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2log_8h-source.html">log.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2random_8h-source.html">random.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2volume_8h-source.html">volume.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2util_8h-source.html">util.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="backup_2zfs-prot_8h-source.html">zfs-prot.h</a>&quot;</code><br>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#cf46d433683a2e20d22d97c72506a5bb">internal_cap_compute_verify</a> (<a class="el" href="structinternal__cap__def.html">internal_cap</a> cap)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static int32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#5dbc841b6279320c58d55559157b274f">verify_capability</a> (<a class="el" href="structzfs__cap__def.html">zfs_cap</a> *cap, <a class="el" href="structinternal__cap__def.html">internal_cap</a> icap)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#fee9a3cc7f0788532e544baf5b88bab4">internal_cap_lock</a> (unsigned int level, <a class="el" href="structinternal__cap__def.html">internal_cap</a> *icapp, <a class="el" href="structvolume__def.html">volume</a> *volp, <a class="el" href="structinternal__dentry__def.html">internal_dentry</a> *dentryp, <a class="el" href="structvirtual__dir__def.html">virtual_dir</a> *vdp, <a class="el" href="structzfs__cap__def.html">zfs_cap</a> *tmp_cap)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#c99317ee3cbde650023fb709f7affff1">internal_cap_unlock</a> (<a class="el" href="structvolume__def.html">volume</a> vol, <a class="el" href="structinternal__dentry__def.html">internal_dentry</a> dentry, <a class="el" href="structvirtual__dir__def.html">virtual_dir</a> vd)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="structinternal__cap__def.html">internal_cap</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#a5695b8fe6ab8ba41c37f366dde832ca">internal_cap_create_fh</a> (<a class="el" href="structinternal__fh__def.html">internal_fh</a> fh, uint32_t flags)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="structinternal__cap__def.html">internal_cap</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#53938019a01f13b3a127a31556638fba">internal_cap_create_vd</a> (<a class="el" href="structvirtual__dir__def.html">virtual_dir</a> vd, uint32_t flags)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#a7f96a06151f0017cc303c927cb19069">internal_cap_destroy</a> (<a class="el" href="structinternal__cap__def.html">internal_cap</a> cap, <a class="el" href="structinternal__fh__def.html">internal_fh</a> fh, <a class="el" href="structvirtual__dir__def.html">virtual_dir</a> vd)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#bd92125beb330e39a1ef31818741d83f">destroy_unused_capabilities</a> (<a class="el" href="structinternal__fh__def.html">internal_fh</a> fh)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#a8e3076b0e4be7d3491ac613f465f8af">get_capability</a> (<a class="el" href="structzfs__cap__def.html">zfs_cap</a> *cap, <a class="el" href="structinternal__cap__def.html">internal_cap</a> *icapp, <a class="el" href="structvolume__def.html">volume</a> *vol, <a class="el" href="structinternal__dentry__def.html">internal_dentry</a> *dentry, <a class="el" href="structvirtual__dir__def.html">virtual_dir</a> *vd, bool unlock_fh_mutex, bool delete_volume_p)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structinternal__cap__def.html">internal_cap</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#0cb6693dca955aa50b37012d5b496626">get_capability_no_zfs_fh_lookup</a> (<a class="el" href="structzfs__cap__def.html">zfs_cap</a> *cap, <a class="el" href="structinternal__dentry__def.html">internal_dentry</a> dentry, uint32_t flags)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#8be3fb9a73caf62d31b6244b64fe4a65">find_capability</a> (<a class="el" href="structzfs__cap__def.html">zfs_cap</a> *cap, <a class="el" href="structinternal__cap__def.html">internal_cap</a> *icapp, <a class="el" href="structvolume__def.html">volume</a> *vol, <a class="el" href="structinternal__dentry__def.html">internal_dentry</a> *dentry, <a class="el" href="structvirtual__dir__def.html">virtual_dir</a> *vd, bool delete_volume_p)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#e09f5a41945b184cfa07227bda352992">find_capability_nolock</a> (<a class="el" href="structzfs__cap__def.html">zfs_cap</a> *cap, <a class="el" href="structinternal__cap__def.html">internal_cap</a> *icapp, <a class="el" href="structvolume__def.html">volume</a> *vol, <a class="el" href="structinternal__dentry__def.html">internal_dentry</a> *dentry, <a class="el" href="structvirtual__dir__def.html">virtual_dir</a> *vd, bool delete_volume_p)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#d12fd51259c19e70bd46953b5c0cb289">put_capability</a> (<a class="el" href="structinternal__cap__def.html">internal_cap</a> cap, <a class="el" href="structinternal__fh__def.html">internal_fh</a> fh, <a class="el" href="structvirtual__dir__def.html">virtual_dir</a> vd)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#769b227d645a6e4201b239468571d269">initialize_cap_c</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#408e75686b4a1d0c06038963df330f14">cleanup_cap_c</a> (void)</td></tr>

<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="structalloc__pool__def.html">alloc_pool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#667647e67b5f01dfcb410545e03958dd">cap_pool</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static pthread_mutex_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="backup_2cap_8c.html#baeb5440e552f7d073bd556b24ca61e0">cap_mutex</a></td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Capability functions. 
<p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="408e75686b4a1d0c06038963df330f14"></a><!-- doxytag: member="backup/cap.c::cleanup_cap_c" ref="408e75686b4a1d0c06038963df330f14" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void cleanup_cap_c           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Destroy data structures in CAP.C. 
</div>
</div><p>
<a class="anchor" name="bd92125beb330e39a1ef31818741d83f"></a><!-- doxytag: member="backup/cap.c::destroy_unused_capabilities" ref="bd92125beb330e39a1ef31818741d83f" args="(internal_fh fh)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void destroy_unused_capabilities           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structinternal__fh__def.html">internal_fh</a>&nbsp;</td>
          <td class="paramname"> <em>fh</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Destroy all unused capabilities associated with file handle FH. 
</div>
</div><p>
<a class="anchor" name="8be3fb9a73caf62d31b6244b64fe4a65"></a><!-- doxytag: member="backup/cap.c::find_capability" ref="8be3fb9a73caf62d31b6244b64fe4a65" args="(zfs_cap *cap, internal_cap *icapp, volume *vol, internal_dentry *dentry, virtual_dir *vd, bool delete_volume_p)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int32_t find_capability           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structzfs__cap__def.html">zfs_cap</a> *&nbsp;</td>
          <td class="paramname"> <em>cap</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__cap__def.html">internal_cap</a> *&nbsp;</td>
          <td class="paramname"> <em>icapp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvolume__def.html">volume</a> *&nbsp;</td>
          <td class="paramname"> <em>vol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__dentry__def.html">internal_dentry</a> *&nbsp;</td>
          <td class="paramname"> <em>dentry</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirtual__dir__def.html">virtual_dir</a> *&nbsp;</td>
          <td class="paramname"> <em>vd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>delete_volume_p</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Find an internal capability CAP and store it to ICAPP. Store capability's volume to VOL, internal dentry DENTRY and virtual directory to VD. If DELETE_VOLUME_P is true and the volume should be deleted do not lookup the file handle and delete the volume if there are no file handles locked on it. 
</div>
</div><p>
<a class="anchor" name="e09f5a41945b184cfa07227bda352992"></a><!-- doxytag: member="backup/cap.c::find_capability_nolock" ref="e09f5a41945b184cfa07227bda352992" args="(zfs_cap *cap, internal_cap *icapp, volume *vol, internal_dentry *dentry, virtual_dir *vd, bool delete_volume_p)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int32_t find_capability_nolock           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structzfs__cap__def.html">zfs_cap</a> *&nbsp;</td>
          <td class="paramname"> <em>cap</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__cap__def.html">internal_cap</a> *&nbsp;</td>
          <td class="paramname"> <em>icapp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvolume__def.html">volume</a> *&nbsp;</td>
          <td class="paramname"> <em>vol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__dentry__def.html">internal_dentry</a> *&nbsp;</td>
          <td class="paramname"> <em>dentry</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirtual__dir__def.html">virtual_dir</a> *&nbsp;</td>
          <td class="paramname"> <em>vd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>delete_volume_p</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Find an internal capability CAP and store it to ICAPP. Store capability's volume to VOL, internal dentry DENTRY and virtual directory to VD. If DELETE_VOLUME_P is true and the volume should be deleted do not lookup the file handle and delete the volume if there are no file handles locked on it. This function is similar to FIND_CAPABILITY but does not lock big locks. 
</div>
</div><p>
<a class="anchor" name="a8e3076b0e4be7d3491ac613f465f8af"></a><!-- doxytag: member="backup/cap.c::get_capability" ref="a8e3076b0e4be7d3491ac613f465f8af" args="(zfs_cap *cap, internal_cap *icapp, volume *vol, internal_dentry *dentry, virtual_dir *vd, bool unlock_fh_mutex, bool delete_volume_p)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int32_t get_capability           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structzfs__cap__def.html">zfs_cap</a> *&nbsp;</td>
          <td class="paramname"> <em>cap</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__cap__def.html">internal_cap</a> *&nbsp;</td>
          <td class="paramname"> <em>icapp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvolume__def.html">volume</a> *&nbsp;</td>
          <td class="paramname"> <em>vol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__dentry__def.html">internal_dentry</a> *&nbsp;</td>
          <td class="paramname"> <em>dentry</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirtual__dir__def.html">virtual_dir</a> *&nbsp;</td>
          <td class="paramname"> <em>vd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>unlock_fh_mutex</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>delete_volume_p</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Get an internal capability CAP and store it to ICAPP. Store capability's volume to VOL, internal file handle IFH and virtual directory to VD. Create a new internal capability if it does not exist. 
</div>
</div><p>
<a class="anchor" name="0cb6693dca955aa50b37012d5b496626"></a><!-- doxytag: member="backup/cap.c::get_capability_no_zfs_fh_lookup" ref="0cb6693dca955aa50b37012d5b496626" args="(zfs_cap *cap, internal_dentry dentry, uint32_t flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structinternal__cap__def.html">internal_cap</a> get_capability_no_zfs_fh_lookup           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structzfs__cap__def.html">zfs_cap</a> *&nbsp;</td>
          <td class="paramname"> <em>cap</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__dentry__def.html">internal_dentry</a>&nbsp;</td>
          <td class="paramname"> <em>dentry</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Return an internal capability for ZFS capability CAP and internal dentry DENTRY. 
</div>
</div><p>
<a class="anchor" name="769b227d645a6e4201b239468571d269"></a><!-- doxytag: member="backup/cap.c::initialize_cap_c" ref="769b227d645a6e4201b239468571d269" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void initialize_cap_c           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Initialize data structures in CAP.C. 
</div>
</div><p>
<a class="anchor" name="cf46d433683a2e20d22d97c72506a5bb"></a><!-- doxytag: member="backup/cap.c::internal_cap_compute_verify" ref="cf46d433683a2e20d22d97c72506a5bb" args="(internal_cap cap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool internal_cap_compute_verify           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structinternal__cap__def.html">internal_cap</a>&nbsp;</td>
          <td class="paramname"> <em>cap</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Compute the verification for the capability and return true on success. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>cap</em>&nbsp;</td><td>Capability which the verification should be computed for. </td></tr>
  </table>
</dl>

</div>
</div><p>
<a class="anchor" name="a5695b8fe6ab8ba41c37f366dde832ca"></a><!-- doxytag: member="backup/cap.c::internal_cap_create_fh" ref="a5695b8fe6ab8ba41c37f366dde832ca" args="(internal_fh fh, uint32_t flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="structinternal__cap__def.html">internal_cap</a> internal_cap_create_fh           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structinternal__fh__def.html">internal_fh</a>&nbsp;</td>
          <td class="paramname"> <em>fh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Create a new capability for file handle fh with open flags FLAGS. 
</div>
</div><p>
<a class="anchor" name="53938019a01f13b3a127a31556638fba"></a><!-- doxytag: member="backup/cap.c::internal_cap_create_vd" ref="53938019a01f13b3a127a31556638fba" args="(virtual_dir vd, uint32_t flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="structinternal__cap__def.html">internal_cap</a> internal_cap_create_vd           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirtual__dir__def.html">virtual_dir</a>&nbsp;</td>
          <td class="paramname"> <em>vd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Create a new capability for virtual directory VD with open flags FLAGS. 
</div>
</div><p>
<a class="anchor" name="a7f96a06151f0017cc303c927cb19069"></a><!-- doxytag: member="backup/cap.c::internal_cap_destroy" ref="a7f96a06151f0017cc303c927cb19069" args="(internal_cap cap, internal_fh fh, virtual_dir vd)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void internal_cap_destroy           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structinternal__cap__def.html">internal_cap</a>&nbsp;</td>
          <td class="paramname"> <em>cap</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__fh__def.html">internal_fh</a>&nbsp;</td>
          <td class="paramname"> <em>fh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirtual__dir__def.html">virtual_dir</a>&nbsp;</td>
          <td class="paramname"> <em>vd</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Destroy capability CAP associated with internal file handle FH or virtual directory VD. 
</div>
</div><p>
<a class="anchor" name="fee9a3cc7f0788532e544baf5b88bab4"></a><!-- doxytag: member="backup/cap.c::internal_cap_lock" ref="fee9a3cc7f0788532e544baf5b88bab4" args="(unsigned int level, internal_cap *icapp, volume *volp, internal_dentry *dentryp, virtual_dir *vdp, zfs_cap *tmp_cap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int32_t internal_cap_lock           </td>
          <td>(</td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>level</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__cap__def.html">internal_cap</a> *&nbsp;</td>
          <td class="paramname"> <em>icapp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvolume__def.html">volume</a> *&nbsp;</td>
          <td class="paramname"> <em>volp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__dentry__def.html">internal_dentry</a> *&nbsp;</td>
          <td class="paramname"> <em>dentryp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirtual__dir__def.html">virtual_dir</a> *&nbsp;</td>
          <td class="paramname"> <em>vdp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structzfs__cap__def.html">zfs_cap</a> *&nbsp;</td>
          <td class="paramname"> <em>tmp_cap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Lock dentry *DENTRYP on volume *VOLP with capability *ICAPP and virtual directory *VDP to level LEVEL. Store the local ZFS file handle to TMP_FH. 
</div>
</div><p>
<a class="anchor" name="c99317ee3cbde650023fb709f7affff1"></a><!-- doxytag: member="backup/cap.c::internal_cap_unlock" ref="c99317ee3cbde650023fb709f7affff1" args="(volume vol, internal_dentry dentry, virtual_dir vd)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void internal_cap_unlock           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvolume__def.html">volume</a>&nbsp;</td>
          <td class="paramname"> <em>vol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__dentry__def.html">internal_dentry</a>&nbsp;</td>
          <td class="paramname"> <em>dentry</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirtual__dir__def.html">virtual_dir</a>&nbsp;</td>
          <td class="paramname"> <em>vd</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Unlock dentry DENTRY and virtual directory VD. 
</div>
</div><p>
<a class="anchor" name="d12fd51259c19e70bd46953b5c0cb289"></a><!-- doxytag: member="backup/cap.c::put_capability" ref="d12fd51259c19e70bd46953b5c0cb289" args="(internal_cap cap, internal_fh fh, virtual_dir vd)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int32_t put_capability           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structinternal__cap__def.html">internal_cap</a>&nbsp;</td>
          <td class="paramname"> <em>cap</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__fh__def.html">internal_fh</a>&nbsp;</td>
          <td class="paramname"> <em>fh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirtual__dir__def.html">virtual_dir</a>&nbsp;</td>
          <td class="paramname"> <em>vd</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Decrease the number of users of capability CAP associated with file handle FH or virtual directory VD and destroy the capability when the number of users becomes 0. 
</div>
</div><p>
<a class="anchor" name="5dbc841b6279320c58d55559157b274f"></a><!-- doxytag: member="backup/cap.c::verify_capability" ref="5dbc841b6279320c58d55559157b274f" args="(zfs_cap *cap, internal_cap icap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int32_t verify_capability           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structzfs__cap__def.html">zfs_cap</a> *&nbsp;</td>
          <td class="paramname"> <em>cap</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinternal__cap__def.html">internal_cap</a>&nbsp;</td>
          <td class="paramname"> <em>icap</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Verify capability CAP by comparing with ICAP. 
</div>
</div><p>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="baeb5440e552f7d073bd556b24ca61e0"></a><!-- doxytag: member="backup/cap.c::cap_mutex" ref="baeb5440e552f7d073bd556b24ca61e0" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">pthread_mutex_t <a class="el" href="cap_8c.html#baeb5440e552f7d073bd556b24ca61e0">cap_mutex</a><code> [static]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Mutex for cap_pool. 
</div>
</div><p>
<a class="anchor" name="667647e67b5f01dfcb410545e03958dd"></a><!-- doxytag: member="backup/cap.c::cap_pool" ref="667647e67b5f01dfcb410545e03958dd" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structalloc__pool__def.html">alloc_pool</a> <a class="el" href="cap_8c.html#667647e67b5f01dfcb410545e03958dd">cap_pool</a><code> [static]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Allocation pool for capabilities. 
</div>
</div><p>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Aug 6 00:37:39 2010 for zlomekFS by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
